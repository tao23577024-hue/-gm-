<!DOCTYPE html>
<html lang="zh-CN" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„åŸºé‡‘å®ç›˜ (GitHubç‰ˆ)</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gray: {
                            50: '#f9fafb', 100: '#f3f4f6', 200: '#e5e7eb', 300: '#d1d5db',
                            800: '#1f2937', 900: '#111827', 950: '#030712' // ææ·±ç°ï¼ŒæŠ¤çœ¼
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* é»„é‡‘æ¯”ä¾‹åœ†è§’ä¸å­—ä½“ä¼˜åŒ– */
        body { font-family: "Microsoft YaHei", -apple-system, BlinkMacSystemFont, sans-serif; }
        .golden-rounded { border-radius: 12px; }
        .transition-colors { transition: all 0.3s ease; }
        /* æ¶¨è·Œé¢œè‰²: çº¢æ¶¨ç»¿è·Œ */
        .up-text { color: #ef4444; }
        .down-text { color: #22c55e; }
        .bg-up { background-color: #fee2e2; color: #991b1b; }
        .bg-down { background-color: #dcfce7; color: #166534; }
        /* å¤œé—´æ¨¡å¼ä¸‹çš„èƒŒæ™¯é€‚é… */
        .dark .bg-up { background-color: #450a0a; color: #fca5a5; }
        .dark .bg-down { background-color: #052e16; color: #86efac; }
        
        [v-cloak] { display: none; }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 transition-colors duration-300 dark:bg-gray-950 dark:text-gray-100">

<div id="app" v-cloak class="min-h-screen p-4 md:p-8 max-w-7xl mx-auto">
    
    <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
        <div>
            <h1 class="text-2xl font-bold tracking-tight">åŸºé‡‘å®ç›˜çœ‹æ¿</h1>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                å®æ—¶ä¼°å€¼ | æ¯5såˆ·æ–° | æ•°æ®æ¥æº: å¤©å¤©åŸºé‡‘
            </p>
        </div>
        <div class="flex gap-3 items-center">
            <div class="relative">
                <input v-model="searchCode" @keyup.enter="addNewFund" type="text" placeholder="è¾“å…¥ä»£ç åŠ ä»“ (å¦‚ 009052)" 
                    class="pl-4 pr-10 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-800 dark:border-gray-700">
                <button @click="addNewFund" class="absolute right-2 top-2 text-blue-600 font-bold">+</button>
            </div>
            <button @click="toggleDarkMode" class="p-2 rounded-lg bg-gray-200 dark:bg-gray-800 hover:bg-gray-300 dark:hover:bg-gray-700 transition">
                {{ isDark ? 'ğŸŒ ç™½å¤©' : 'ğŸŒ™ å¤œé—´' }}
            </button>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="p-6 bg-white dark:bg-gray-900 golden-rounded shadow-sm border border-gray-200 dark:border-gray-800">
            <h3 class="text-sm text-gray-500 dark:text-gray-400">é¢„ä¼°ä»Šæ—¥æ”¶ç›Š</h3>
            <p class="text-3xl font-bold mt-2 font-mono" :class="totalDailyProfit >= 0 ? 'up-text' : 'down-text'">
                {{ totalDailyProfit >= 0 ? '+' : '' }}{{ totalDailyProfit }}
            </p>
        </div>
        <div class="p-6 bg-white dark:bg-gray-900 golden-rounded shadow-sm border border-gray-200 dark:border-gray-800">
            <h3 class="text-sm text-gray-500 dark:text-gray-400">æŒæœ‰æ€»é‡‘é¢</h3>
            <p class="text-3xl font-bold mt-2 font-mono">{{ totalAmount }}</p>
        </div>
        <div class="p-6 bg-white dark:bg-gray-900 golden-rounded shadow-sm border border-gray-200 dark:border-gray-800">
            <h3 class="text-sm text-gray-500 dark:text-gray-400">ä¸Šæ¬¡æ›´æ–°æ—¶é—´</h3>
            <p class="text-xl font-bold mt-2 font-mono">{{ lastUpdateTime }}</p>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
        <div v-for="(fund, index) in funds" :key="fund.code" 
             class="bg-white dark:bg-gray-900 golden-rounded shadow-sm border border-gray-200 dark:border-gray-800 hover:shadow-md transition relative group">
            
            <button @click="removeFund(index)" class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 text-gray-400 hover:text-red-500 p-1">âœ•</button>

            <div class="p-6 cursor-pointer" @click="openDetail(fund)">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h3 class="font-bold text-lg truncate w-48">{{ fund.name || 'åŠ è½½ä¸­...' }}</h3>
                        <span class="text-xs text-gray-400 bg-gray-100 dark:bg-gray-800 px-2 py-1 rounded">{{ fund.code }}</span>
                    </div>
                    <div class="text-right">
                        <span class="text-2xl font-mono font-bold block" :class="fund.gszzl >= 0 ? 'up-text' : 'down-text'">
                            {{ fund.gszzl }}%
                        </span>
                        <span class="text-xs text-gray-400">ä¼°ç®—æ¶¨å¹…</span>
                    </div>
                </div>

                <div :id="'chart-' + fund.code" style="width: 100%; height: 60px;"></div>

                <div class="grid grid-cols-2 gap-4 mt-4 pt-4 border-t border-gray-100 dark:border-gray-800">
                    <div>
                        <p class="text-xs text-gray-500">æŒæœ‰é‡‘é¢</p>
                        <input type="number" v-model.number="fund.holdAmount" @click.stop @change="saveData"
                            class="w-full bg-transparent border-b border-gray-300 dark:border-gray-700 font-mono focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <p class="text-xs text-gray-500">é¢„ä¼°æ”¶ç›Š</p>
                        <p class="font-mono font-bold" :class="calcProfit(fund) >= 0 ? 'up-text' : 'down-text'">
                            {{ calcProfit(fund) }}
                        </p>
                    </div>
                    <div>
                        <p class="text-xs text-gray-500">å®æ—¶å‡€å€¼</p>
                        <p class="font-mono">{{ fund.gsz }}</p>
                    </div>
                    <div>
                        <p class="text-xs text-gray-500">æ˜¨æ—¥å‡€å€¼</p>
                        <p class="font-mono text-gray-600 dark:text-gray-400">{{ fund.dwjz }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div v-if="showModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" @click.self="showModal = false">
        <div class="bg-white dark:bg-gray-900 golden-rounded p-6 w-full max-w-2xl m-4 shadow-2xl border border-gray-200 dark:border-gray-700">
            <h2 class="text-xl font-bold mb-4">{{ currentFund.name }} ({{ currentFund.code }})</h2>
            
            <div class="mb-4">
                <h3 class="text-sm font-bold text-gray-500 mb-2">è¿‘30æ—¥å‡€å€¼èµ°åŠ¿</h3>
                <img :src="`http://j4.dfcfw.com/charts/pic/${currentFund.code}.png`" class="w-full rounded-lg bg-white p-2 border" alt="èµ°åŠ¿å›¾">
            </div>
            
            <div class="h-64 w-full" id="detailChart"></div>

            <button @click="showModal = false" class="mt-4 w-full py-2 bg-gray-200 dark:bg-gray-800 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-700">å…³é—­</button>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, computed, onMounted, watch } = Vue;

    createApp({
        setup() {
            // --- çŠ¶æ€æ•°æ® ---
            const funds = ref([]);
            const searchCode = ref("");
            const isDark = ref(false);
            const lastUpdateTime = ref("--:--");
            const showModal = ref(false);
            const currentFund = ref({});
            
            // æé†’é˜ˆå€¼è®¾ç½®
            const alertThreshold = 2.0; // æ¶¨è·Œè¶…è¿‡2%æé†’

            // æ¨¡æ‹Ÿå†å²æ•°æ®å­˜å‚¨ (ç”¨äºç”»å›¾)
            const chartHistory = ref({}); // { '009052': [{time: '10:00', value: 1.23}, ...] }

            // --- æ ¸å¿ƒé€»è¾‘: è·å–æ•°æ® (JSONP) ---
            const fetchFundData = (code) => {
                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    // åŠ ä¸Š rt æ—¶é—´æˆ³é˜²æ­¢ç¼“å­˜
                    const timestamp = new Date().getTime();
                    script.src = `https://fundgz.1234567.com.cn/js/${code}.js?rt=${timestamp}`;
                    
                    // JSONP å›è°ƒå¤„ç†
                    script.onload = () => {
                        try {
                            // æ¥å£è¿”å›çš„æ˜¯ var jsonpgz({"fundcode":...});
                            // æˆ‘ä»¬ç›´æ¥è¯»å– window.jsonpgz é‡Œçš„å†…å®¹ï¼Œä½†å› ä¸ºæ˜¯é—­åŒ…å¾ˆéš¾è·å–
                            // æ›´å¥½çš„åŠæ³•æ˜¯ç›´æ¥è§£æ script æ ‡ç­¾é‡Œçš„å†…å®¹ä¸å¤ªè¡Œ
                            // å¤©å¤©åŸºé‡‘çš„è¿™ä¸ªæ¥å£ä¼šç›´æ¥æ‰§è¡Œ jsonpgz(...) å‡½æ•°
                            // æ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨å…¨å±€å®šä¹‰è¿™ä¸ªå‡½æ•°æ¥æ‹¦æˆªæ•°æ®
                        } catch (e) { reject(e); }
                        document.body.removeChild(script);
                    };
                    script.onerror = () => {
                        document.body.removeChild(script);
                        reject("Network Error");
                    };
                    document.body.appendChild(script);
                });
            };

            // å…¨å±€ JSONP å›è°ƒåŠ«æŒ
            window.jsonpgz = (data) => {
                const target = funds.value.find(f => f.code === data.fundcode);
                if (target) {
                    target.name = data.name;
                    target.dwjz = data.dwjz; // æ˜¨æ—¥å‡€å€¼
                    target.gsz = data.gsz;   // å®æ—¶ä¼°å€¼
                    target.gszzl = data.gszzl; // æ¶¨å¹…
                    target.gztime = data.gztime;
                    
                    // è§¦å‘æé†’
                    if (Math.abs(parseFloat(data.gszzl)) > alertThreshold) {
                       checkAlert(target);
                    }

                    // è®°å½•å›¾è¡¨æ•°æ®
                    recordChartData(target.code, data.gsz, data.gztime);
                } else if (searchCode.value === data.fundcode) {
                    // å¦‚æœæ˜¯æœç´¢æ·»åŠ çš„æƒ…å†µ
                    addNewFundToList(data);
                }
            };

            const recordChartData = (code, value, time) => {
                if (!chartHistory.value[code]) chartHistory.value[code] = [];
                const history = chartHistory.value[code];
                // é¿å…é‡å¤æ—¶é—´ç‚¹
                if (history.length > 0 && history[history.length-1].time === time) return;
                
                history.push({ time, value });
                // åªä¿ç•™æœ€è¿‘ 50 ä¸ªç‚¹æ¨¡æ‹Ÿ K çº¿/åˆ†æ—¶
                if (history.length > 50) history.shift();
                
                // æ›´æ–°å°å›¾è¡¨
                setTimeout(() => renderMiniChart(code), 0);
            };

            // --- åŠŸèƒ½å®ç° ---

            const updateAll = () => {
                const now = new Date();
                lastUpdateTime.value = now.toLocaleTimeString();
                funds.value.forEach(f => {
                    fetchFundData(f.code);
                });
            };

            const addNewFund = () => {
                if (!searchCode.value) return;
                // å…ˆå°è¯•è·å–æ•°æ®ï¼Œå¦‚æœæˆåŠŸåˆ™æ·»åŠ 
                fetchFundData(searchCode.value);
            };

            const addNewFundToList = (data) => {
                // æŸ¥é‡
                if (funds.value.find(f => f.code === data.fundcode)) {
                    alert("è¯¥åŸºé‡‘å·²å­˜åœ¨");
                    searchCode.value = "";
                    return;
                }
                funds.value.push({
                    code: data.fundcode,
                    name: data.name,
                    holdAmount: 1000, // é»˜è®¤æŒæœ‰é‡‘é¢
                    gsz: data.gsz,
                    dwjz: data.dwjz,
                    gszzl: data.gszzl,
                    gztime: data.gztime
                });
                searchCode.value = "";
                saveData();
            };

            const removeFund = (index) => {
                if(confirm("ç¡®å®šåˆ é™¤å—ï¼Ÿ")) {
                    funds.value.splice(index, 1);
                    saveData();
                }
            };

            // è®¡ç®—é¢„ä¼°æ”¶ç›Š: æŒæœ‰é‡‘é¢ * (æ¶¨è·Œå¹… / 100)
            // ç®€å•ç®—æ³•ï¼šå‡è®¾æŒæœ‰é‡‘é¢æ˜¯åŸºäºæ˜¨æ—¥å‡€å€¼çš„
            const calcProfit = (fund) => {
                if (!fund.holdAmount || !fund.gszzl) return "0.00";
                const profit = (fund.holdAmount * (parseFloat(fund.gszzl) / 100));
                return profit.toFixed(2);
            };

            const totalDailyProfit = computed(() => {
                let total = 0;
                funds.value.forEach(f => {
                    total += parseFloat(calcProfit(f));
                });
                return total.toFixed(2);
            });

            const totalAmount = computed(() => {
                return funds.value.reduce((acc, cur) => acc + (cur.holdAmount || 0), 0).toFixed(2);
            });

            // æé†’åŠŸèƒ½
            const checkAlert = (fund) => {
                if (Notification.permission === "granted") {
                    // é˜²æ­¢é¢‘ç¹å¼¹çª—ï¼Œè¿™é‡Œå¯ä»¥åŠ ä¸ªæ ‡å¿—ä½æ§åˆ¶
                    // new Notification(`é¢„è­¦: ${fund.name}`, { body: `æ¶¨è·Œå¹…å·²è¾¾ ${fund.gszzl}%` });
                }
            };

            // --- æŒä¹…åŒ–å­˜å‚¨ ---
            const saveData = () => {
                localStorage.setItem('myFunds', JSON.stringify(funds.value));
            };

            const loadData = () => {
                const saved = localStorage.getItem('myFunds');
                if (saved) funds.value = JSON.parse(saved);
                else {
                    // é»˜è®¤æ·»åŠ å‡ ä¸ªçƒ­é—¨åŸºé‡‘åšæ¼”ç¤º
                    funds.value = [{code: '009052', holdAmount: 5000}, {code: '161725', holdAmount: 10000}];
                }
            };

            // --- UI è¾…åŠ© ---
            const toggleDarkMode = () => {
                isDark.value = !isDark.value;
                if (isDark.value) document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
            };

            const openDetail = (fund) => {
                currentFund.value = fund;
                showModal.value = true;
                // æ¸²æŸ“å¤§å›¾
                setTimeout(() => {
                    renderDetailChart(fund.code);
                }, 100);
            };

            // --- å›¾è¡¨æ¸²æŸ“ (ECharts) ---
            const renderMiniChart = (code) => {
                const dom = document.getElementById('chart-' + code);
                if (!dom) return;
                let chart = echarts.getInstanceByDom(dom);
                if (!chart) chart = echarts.init(dom);
                
                const data = chartHistory.value[code] || [];
                const values = data.map(i => i.value);
                
                // åˆ¤æ–­é¢œè‰²
                const isUp = values.length > 1 && values[values.length-1] > values[0];
                const color = isUp ? '#ef4444' : '#22c55e';

                chart.setOption({
                    grid: { top: 0, bottom: 0, left: 0, right: 0 },
                    xAxis: { show: false, data: data.map(i => i.time) },
                    yAxis: { show: false, min: 'dataMin', max: 'dataMax' },
                    series: [{
                        type: 'line',
                        data: values,
                        showSymbol: false,
                        lineStyle: { width: 2, color: color },
                        areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: color },
                                { offset: 1, color: 'rgba(255,255,255,0)' }
                            ]),
                            opacity: 0.2
                        }
                    }]
                });
            };

            const renderDetailChart = (code) => {
                 const dom = document.getElementById('detailChart');
                 if(!dom) return;
                 let chart = echarts.init(dom);
                 const data = chartHistory.value[code] || [];
                 
                 chart.setOption({
                     title: { text: 'ä»Šæ—¥å®æ—¶æ¨¡æ‹Ÿèµ°åŠ¿', left: 'center' },
                     tooltip: { trigger: 'axis' },
                     xAxis: { data: data.map(i => i.time) },
                     yAxis: { scale: true },
                     series: [{
                         type: 'line',
                         data: data.map(i => i.value),
                         smooth: true,
                         itemStyle: { color: '#007AFF' }
                     }]
                 });
            };

            // --- ç”Ÿå‘½å‘¨æœŸ ---
            onMounted(() => {
                loadData();
                updateAll();
                
                // å¼€å¯ 5s è½®è¯¢
                setInterval(updateAll, 5000);

                // è¯·æ±‚é€šçŸ¥æƒé™
                if (Notification.permission !== "granted") {
                    Notification.requestPermission();
                }

                // è‡ªåŠ¨é€‚åº”ç³»ç»Ÿå¤œé—´æ¨¡å¼
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    toggleDarkMode();
                }
            });

            return {
                funds, searchCode, isDark, lastUpdateTime, 
                addNewFund, removeFund, toggleDarkMode, calcProfit, 
                totalDailyProfit, totalAmount, saveData,
                showModal, currentFund, openDetail
            };
        }
    }).mount('#app');
</script>
</body>
</html>
