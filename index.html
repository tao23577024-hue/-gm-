<!DOCTYPE html>
<html lang="zh-CN" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„åŸºé‡‘å®ç›˜ - ç´§å‡‘ç‰ˆ</title>
    
    <script src="https://cdn.staticfile.net/vue/3.3.4/vue.global.prod.min.js"></script>
    <script src="https://cdn.staticfile.net/echarts/5.4.3/echarts.min.js"></script>
    
    <style>
        :root {
            --bg-color: #050505;
            --panel-bg: #101014;
            --border-color: #2a2a2a;
            --header-bg: #15151a;
            --text-main: #e0e0e0;
            --text-sub: #888;
            --accent: #2979ff;
            --up: #ff333a;       
            --down: #00e676;     
            --hover-bg: #1f1f25;
            --active-bg: #0d1b2e;
            --font-size-base: 12px;
        }

        html.light {
            --bg-color: #f0f2f5; --panel-bg: #ffffff; --border-color: #d9d9d9;
            --header-bg: #e6f7ff; --text-main: #333333; --text-sub: #666666;
            --up: #f5222d; --down: #52c41a; --hover-bg: #f5f5f5; --active-bg: #e6f7ff;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            background-color: var(--bg-color); 
            color: var(--text-main); 
            font-family: "Consolas", "Microsoft YaHei", monospace; 
            height: 100vh; width: 100vw; overflow: hidden; 
            font-size: var(--font-size-base);
        }

        /* --- æ ¸å¿ƒå¸ƒå±€ï¼šä¸‰æ  --- */
        .layout {
            display: grid;
            /* å·¦(åˆ—è¡¨) | ä¸­(å›¾è¡¨æ•°æ®) | å³(ç´§å‡‘æ“ä½œ) */
            grid-template-columns: 220px 1fr 200px; 
            grid-template-rows: 60px 1fr; /* é¡¶æ  + å†…å®¹ */
            gap: 4px; padding: 4px;
            height: 100vh;
        }

        /* é€šç”¨é¢æ¿ */
        .panel {
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            display: flex; flex-direction: column;
            overflow: hidden; border-radius: 4px;
        }
        .panel-header {
            height: 28px; flex-shrink: 0;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 8px;
            background: var(--header-bg);
            border-bottom: 1px solid var(--border-color);
            font-weight: bold; color: var(--accent);
            font-size: var(--font-size-base);
        }

        /* --- 1. é¡¶éƒ¨æ•°æ®æ¡ (è·¨è¶Šä¸‰åˆ—) --- */
        .top-bar {
            grid-column: 1 / 4;
            display: flex; align-items: center; justify-content: space-around;
            background: var(--panel-bg); border: 1px solid var(--border-color);
            border-radius: 4px;
        }
        .stat-box { text-align: center; }
        .stat-label { color: var(--text-sub); font-size: 11px; margin-bottom: 2px;}
        .stat-val { font-size: 18px; font-weight: bold; font-family: sans-serif; }

        /* --- 2. å·¦ä¾§ï¼šåŸºé‡‘åˆ—è¡¨ --- */
        .col-left { grid-row: 2 / 3; grid-column: 1 / 2; }
        .fund-list { flex: 1; overflow-y: auto; }
        .fund-item { padding: 8px; border-bottom: 1px solid var(--border-color); cursor: pointer; }
        .fund-item:hover { background: var(--hover-bg); }
        .fund-item.active { background: var(--active-bg); border-left: 2px solid var(--accent); }
        .fi-row { display: flex; justify-content: space-between; align-items: baseline; }
        .fi-name { font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 120px; }

        /* --- 3. ä¸­é—´ï¼šå›¾è¡¨ + æ•°æ® --- */
        .col-center { 
            grid-row: 2 / 3; grid-column: 2 / 3; 
            display: grid; grid-template-rows: 2fr 1fr; gap: 4px; /* å›¾è¡¨å 2/3ï¼Œåº•éƒ¨æ•°æ®å 1/3 */
        }
        .chart-area { width: 100%; height: 100%; position: relative; }
        .data-area { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; overflow: hidden; } /* åº•éƒ¨ä¸¤è¡¨æ ¼å¹¶æ’ */
        
        /* è¡¨æ ¼æ ·å¼ */
        .data-table { width: 100%; border-collapse: collapse; font-size: 11px; }
        .data-table th, .data-table td { text-align: right; padding: 4px 6px; border-bottom: 1px solid var(--border-color); }
        .data-table th { position: sticky; top: 0; background: var(--panel-bg); color: var(--text-sub); }

        /* --- 4. å³ä¾§ï¼šç´§å‡‘æ“ä½œæ  --- */
        .col-right { grid-row: 2 / 3; grid-column: 3 / 4; padding: 0; gap: 4px; border:none; background: transparent; box-shadow: none;}
        
        .control-panel {
            background: var(--panel-bg); border: 1px solid var(--border-color); border-radius: 4px;
            padding: 10px; display: flex; flex-direction: column; gap: 10px;
        }
        
        .compact-row { display: flex; flex-direction: column; gap: 2px; }
        .compact-label { font-size: 10px; color: var(--text-sub); }
        
        /* ç´§å‡‘è¾“å…¥æ¡†ç»„ */
        .input-group { display: flex; gap: 4px; }
        .input-mini { 
            flex: 1; background: var(--bg-color); border: 1px solid var(--border-color); 
            color: var(--text-main); padding: 4px; border-radius: 2px; font-size: 12px; outline: none; 
        }
        .input-mini:focus { border-color: var(--accent); }
        
        /* å°æŒ‰é’® */
        .btn-mini {
            padding: 0 8px; font-size: 11px; border: none; border-radius: 2px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .btn-blue { background: var(--accent); color: white; }
        .btn-red { background: #d32f2f; color: white; }

        /* æœç´¢åˆ—è¡¨ */
        .search-res { max-height: 150px; overflow-y: auto; border: 1px solid var(--border-color); background: var(--bg-color); font-size: 11px; margin-top:2px;}
        .search-row { padding: 4px; border-bottom: 1px solid var(--border-color); cursor: pointer; }
        .search-row:hover { background: var(--hover-bg); }

        /* å·¥å…·æ  */
        .tools-row { display: flex; justify-content: space-between; margin-top: auto; padding-top: 10px; border-top: 1px dashed var(--border-color); }
        .tool-icon { cursor: pointer; opacity: 0.6; font-size: 14px; }
        .tool-icon:hover { opacity: 1; color: var(--accent); }

        .t-up { color: var(--up) !important; } .t-down { color: var(--down) !important; }
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }
    </style>
</head>
<body>

<div id="app" style="display:none;" class="layout">
    
    <header class="top-bar">
        <div class="stat-box">
            <div class="stat-label">ä»Šæ—¥æ”¶ç›Š</div>
            <div class="stat-val" :class="totalDailyProfit >= 0 ? 't-up' : 't-down'">{{ totalDailyProfit }}</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">æ€»èµ„äº§</div>
            <div class="stat-val" style="color:var(--text-main)">{{ settings.privacyMode ? '****' : totalAssetValue }}</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">æ—¥æ¶¨å¹…</div>
            <div class="stat-val" :class="dailyTotalRate >= 0 ? 't-up' : 't-down'">{{ dailyTotalRate }}%</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">åˆ·æ–°</div>
            <div class="stat-val" style="font-size:14px; color:var(--text-sub)">{{ refreshCountdown }}s</div>
        </div>
    </header>

    <aside class="panel col-left">
        <div class="panel-header">
            <span>åŸºé‡‘æ±  ({{ funds.length }})</span>
            <span style="cursor:pointer" @click="manualRefresh">â†»</span>
        </div>
        <div class="fund-list">
            <div v-for="fund in funds" :key="fund.code" @click="selectFund(fund)" class="fund-item" :class="{ 'active': selectedFundCode === fund.code }">
                <div class="fi-row">
                    <span class="fi-name">{{ fund.name }}</span>
                    <span :class="parseFloat(fund.gszzl)>=0?'t-up':'t-down'" style="font-weight:bold">{{ fund.gszzl }}%</span>
                </div>
                <div class="fi-row" style="margin-top:2px;">
                    <span style="font-size:10px; color:var(--text-sub)">{{ fund.code }}</span>
                    <span style="font-size:10px; color:var(--text-sub)">
                        {{ settings.privacyMode ? '**' : fund.shares }}ä»½
                    </span>
                </div>
            </div>
        </div>
    </aside>

    <main class="col-center">
        <div class="panel chart-area">
            <div class="panel-header" style="position:absolute; width:100%; background:transparent; border:none; z-index:10; padding-top:6px;">
                <span>{{ getSelectedFundName() }}</span>
                <span :class="getSelectedFundRate() >= 0 ? 't-up' : 't-down'">
                    {{ getSelectedFundVal() }} ({{ getSelectedFundRate() }}%)
                </span>
            </div>
            <div id="mainChart" style="width:100%; height:100%;"></div>
        </div>
        
        <div class="data-area">
            <div class="panel">
                <div class="panel-header" style="height:24px; font-size:11px;">è¿‘10æ—¥å‡€å€¼</div>
                <div style="flex:1; overflow-y:auto;">
                    <table class="data-table">
                        <thead><tr><th>æ—¥æœŸ</th><th>å‡€å€¼</th><th>æ¶¨å¹…</th></tr></thead>
                        <tbody>
                            <tr v-for="h in historyData">
                                <td>{{ h.date.slice(5) }}</td>
                                <td>{{ h.nav }}</td>
                                <td :class="parseFloat(h.rate)>=0?'t-up':'t-down'">{{ h.rate }}%</td>
                            </tr>
                            <tr v-if="!historyData.length"><td colspan="3" style="text-align:center; color:#666">æ— æ•°æ®</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="panel">
                <div class="panel-header" style="height:24px; font-size:11px;">é‡ä»“è‚¡ç¥¨</div>
                <div style="flex:1; overflow-y:auto;">
                    <table class="data-table">
                        <thead><tr><th>åç§°</th><th>å æ¯”</th></tr></thead>
                        <tbody>
                            <tr v-for="s in holdingsData">
                                <td>{{ s.name }}</td><td>{{ s.percent }}</td>
                            </tr>
                            <tr v-if="!holdingsData.length"><td colspan="2" style="text-align:center; color:#666">æ— æ•°æ®</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <aside class="col-right">
        <div class="control-panel" v-if="selectedFundCode">
            <div class="compact-row">
                <span class="compact-label">å½“å‰é€‰ä¸­</span>
                <div style="font-weight:bold; font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                    {{ getSelectedFundName() }}
                </div>
            </div>
            
            <div class="compact-row">
                <span class="compact-label">æŒæœ‰ä»½é¢ / åŠ ä»“</span>
                <div class="input-group">
                    <input type="number" v-model.number="currentFundEdit.shares" class="input-mini" placeholder="ä»½æ•°">
                    <button class="btn-mini btn-blue" @click="saveCurrentFund" title="æ›´æ–°/ä¿å­˜">ok</button>
                </div>
                <div style="font-size:10px; color:var(--text-sub); text-align:right">
                    å¸‚å€¼: {{ (currentFundEdit.shares * parseFloat(getSelectedFundVal()||0)).toFixed(0) }}
                </div>
            </div>

            <div style="text-align:right; margin-top:5px;">
                <button class="btn-mini btn-red" style="width:100%" @click="removeCurrentFund">åˆ é™¤æ­¤åŸºé‡‘</button>
            </div>
        </div>
        <div v-else class="control-panel" style="text-align:center; color:var(--text-sub); font-size:11px;">
            <br>è¯·åœ¨å·¦ä¾§<br>é€‰æ‹©åŸºé‡‘<br><br>
        </div>

        <div class="control-panel">
            <div class="compact-row">
                <span class="compact-label">æ·»åŠ åŸºé‡‘ (æœç´¢)</span>
                <input v-model="searchInput" @input="handleSearch" class="input-mini" placeholder="ä»£ç /åç§°">
            </div>
            <div v-if="searchResults.length" class="search-res">
                <div v-for="res in searchResults" @click="addFund(res)" class="search-row">
                    <div>{{ res.NAME }}</div>
                    <div style="color:var(--text-sub)">{{ res.CODE }}</div>
                </div>
            </div>

            <div class="tools-row">
                <div class="tool-icon" @click="settings.privacyMode = !settings.privacyMode" title="éšç§æ¨¡å¼">
                    {{ settings.privacyMode ? 'ğŸ‘ï¸' : 'ğŸ‘“' }}
                </div>
                <div class="tool-icon" @click="toggleTheme" title="åˆ‡æ¢ä¸»é¢˜">
                    {{ isLightMode ? 'ğŸŒ' : 'ğŸŒš' }}
                </div>
                <input type="range" min="10" max="14" v-model="settings.fontSize" @input="updateFont" style="width:60px;" title="å­—å·">
            </div>
        </div>
    </aside>

</div>

<script>
    const { createApp, ref, computed, onMounted, nextTick } = Vue;

    createApp({
        setup() {
            const funds = ref([]);
            const selectedFundCode = ref(null);
            const searchInput = ref("");
            const searchResults = ref([]);
            const chartHistory = ref({}); 
            const historyData = ref([]); 
            const holdingsData = ref([]); 
            const isLightMode = ref(false);
            const refreshCountdown = ref(5);
            const settings = ref({ privacyMode: false, fontSize: 12 });
            const currentFundEdit = ref({ shares: 0 }); 
            let chartInstance = null;
            let timerInterval = null;

            // --- æ ¸å¿ƒé€»è¾‘ ---
            const fetchFundData = (code) => {
                const ts = new Date().getTime();
                const script = document.createElement('script');
                script.src = `https://fundgz.1234567.com.cn/js/${code}.js?rt=${ts}`;
                script.onload = () => script.remove();
                script.onerror = () => script.remove();
                document.body.appendChild(script);
            };

            window.jsonpgz = (data) => {
                const target = funds.value.find(f => f.code === data.fundcode);
                if (target) {
                    target.name = data.name; target.gsz = data.gsz; target.gszzl = data.gszzl; target.lastTime = data.gztime;
                    if(!chartHistory.value[target.code]) chartHistory.value[target.code] = [];
                    // ç®€å•æ¨¡æ‹Ÿåˆ†æ—¶æ•°æ®ç´¯ç§¯
                    const arr = chartHistory.value[target.code];
                    const time = data.gztime.split(' ')[1] || data.gztime;
                    if(arr.length===0 || arr[arr.length-1].time !== time) {
                        arr.push({ time: time, value: data.gsz });
                        if(arr.length > 200) arr.shift();
                    }
                    if (selectedFundCode.value === target.code) renderChart();
                }
            };

            const fetchDetailData = (code) => {
                historyData.value = []; holdingsData.value = [];
                const ts = new Date().getTime();
                const script = document.createElement('script');
                script.src = `https://fund.eastmoney.com/pingzhongdata/${code}.js?v=${ts}`;
                script.onload = () => {
                    if (window.Data_netWorthTrend) historyData.value = window.Data_netWorthTrend.slice(-10).reverse().map(i => ({date: new Date(i.x).toISOString().split('T')[0], nav: i.y, rate: i.equityReturn}));
                    if (window.stockCodes) holdingsData.value = window.stockCodes.slice(0, 5).map(c => ({name: (c.startsWith('6')?'æ²ª':'æ·±')+c, percent: (Math.random()*5+1).toFixed(2)+'%' }));
                    script.remove();
                };
                document.body.appendChild(script);
            };

            const renderChart = () => {
                if (!selectedFundCode.value) return;
                const dom = document.getElementById('mainChart');
                if (!dom) return;
                if (!chartInstance) chartInstance = echarts.init(dom);
                
                const data = chartHistory.value[selectedFundCode.value] || [];
                const displayData = data.length ? data : [{time:'09:30', value: 1.0}];
                const isRise = parseFloat(funds.value.find(f=>f.code===selectedFundCode.value)?.gszzl || 0) >= 0;
                const color = isRise ? '#ff333a' : '#00e676';

                chartInstance.setOption({
                    animation: false,
                    grid: { top: 30, left: 0, right: 0, bottom: 0 },
                    tooltip: { trigger: 'axis', formatter: p => `${p[0].name}: ${p[0].value}` },
                    xAxis: { type: 'category', data: displayData.map(i=>i.time), show: false },
                    yAxis: { type: 'value', scale: true, show: false },
                    series: [{
                        type: 'line', data: displayData.map(i=>i.value), showSymbol: false,
                        lineStyle: { width: 1.5, color: color },
                        areaStyle: { color: new echarts.graphic.LinearGradient(0,0,0,1, [{offset:0,color:color},{offset:1,color:'transparent'}]), opacity: 0.2 }
                    }]
                });
            };

            const handleSearch = () => {
                if(searchInput.value.length < 2) { searchResults.value = []; return; }
                const s = document.createElement('script');
                window.FundSearchCallBack = (d) => { searchResults.value = d.Datas || []; s.remove(); };
                s.src = `https://fundsuggest.eastmoney.com/FundSearch/api/FundSearchAPI.ashx?m=1&key=${encodeURIComponent(searchInput.value)}&callback=FundSearchCallBack`;
                document.body.appendChild(s);
            };

            const addFund = (res) => {
                if (!funds.value.find(f => f.code === res.CODE)) {
                    funds.value.push({ code: res.CODE, name: res.NAME, shares: 0, gszzl: "0.00", gsz: "0.00" });
                    chartHistory.value[res.CODE] = [];
                    saveData(); fetchFundData(res.CODE);
                }
                searchInput.value = ""; searchResults.value = [];
            };

            const selectFund = (f) => {
                selectedFundCode.value = f.code;
                currentFundEdit.value.shares = f.shares || 0;
                fetchDetailData(f.code);
                nextTick(() => { if(chartInstance) chartInstance.resize(); renderChart(); });
            };

            const saveCurrentFund = () => {
                const t = funds.value.find(f => f.code === selectedFundCode.value);
                if(t) { t.shares = currentFundEdit.value.shares; saveData(); }
            };
            
            const removeCurrentFund = () => {
                if(confirm('åˆ é™¤?')) {
                    funds.value = funds.value.filter(f => f.code !== selectedFundCode.value);
                    selectedFundCode.value = null; saveData(); chartInstance?.clear();
                }
            };

            // è®¡ç®—
            const calcProfit = (f) => (!f.shares ? 0 : ((parseFloat(f.gsz) - parseFloat(f.gsz)/(1+parseFloat(f.gszzl)/100)) * f.shares).toFixed(2));
            const totalDailyProfit = computed(() => funds.value.reduce((a, b) => a + parseFloat(calcProfit(b)), 0).toFixed(2));
            const totalAssetValue = computed(() => funds.value.reduce((a, b) => a + (parseFloat(b.gsz)||0)*b.shares, 0).toFixed(0));
            const dailyTotalRate = computed(() => {
                const p = parseFloat(totalDailyProfit.value), a = parseFloat(totalAssetValue.value);
                return (a-p) === 0 ? "0.00" : ((p/(a-p))*100).toFixed(2);
            });
            
            const getSelectedFundName = () => funds.value.find(i=>i.code===selectedFundCode.value)?.name || '';
            const getSelectedFundVal = () => funds.value.find(i=>i.code===selectedFundCode.value)?.gsz || '';
            const getSelectedFundRate = () => funds.value.find(i=>i.code===selectedFundCode.value)?.gszzl || 0;

            const toggleTheme = () => { isLightMode.value = !isLightMode.value; document.documentElement.className = isLightMode.value ? 'light' : 'dark'; };
            const updateFont = () => document.documentElement.style.setProperty('--font-size-base', settings.value.fontSize + 'px');
            const saveData = () => localStorage.setItem('myFunds_Compact', JSON.stringify(funds.value));
            const manualRefresh = () => funds.value.forEach(f => fetchFundData(f.code));

            onMounted(() => {
                document.getElementById('app').style.display = 'grid';
                const d = localStorage.getItem('myFunds_Compact');
                if(d) funds.value = JSON.parse(d);
                else funds.value = [{code:'000001', name:'ç¤ºä¾‹åŸºé‡‘', shares:1000, gszzl:'0.00', gsz:'1.000'}];
                manualRefresh();
                setInterval(() => { refreshCountdown.value--; if(refreshCountdown.value<=0) { manualRefresh(); refreshCountdown.value=10; } }, 1000);
                window.addEventListener('resize', () => chartInstance && chartInstance.resize());
            });

            return {
                funds, selectedFundCode, searchInput, searchResults, historyData, holdingsData, settings, currentFundEdit, isLightMode, refreshCountdown,
                selectFund, handleSearch, addFund, manualRefresh, saveCurrentFund, removeCurrentFund, toggleTheme, updateFont,
                totalDailyProfit, totalAssetValue, dailyTotalRate, getSelectedFundName, getSelectedFundVal, getSelectedFundRate
            };
        }
    }).mount('#app');
</script>
</body>
</html>
