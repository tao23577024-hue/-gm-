<!DOCTYPE html>
<html lang="zh-CN" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GGB)</title>
    
    <script src="https://lib.baomitu.com/vue/3.3.4/vue.global.prod.min.js"></script>
    <script src="https://lib.baomitu.com/echarts/5.4.3/echarts.min.js"></script>
    
    <style>
        /* --- 2. æ ¸å¿ƒä¿®å¤ï¼šåŸç”Ÿ CSS æ ·å¼ (å½»åº•å‘Šåˆ« Tailwind åŠ è½½å¡é¡¿) --- */
        :root {
            --bg-color: #0B0E14;
            --card-bg: #111827;
            --border-color: #1f2937;
            --text-main: #d1d5db;
            --text-sub: #6b7280;
            --accent-blue: #3b82f6;
            --up-color: #FE2C39;
            --down-color: #00B578;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body { 
            font-family: "PingFang SC", "Microsoft YaHei", sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-main);
            overflow: hidden; /* é˜²æ­¢é¡µé¢æ•´ä½“æ»šåŠ¨ */
            height: 100vh;
        }

        /* å¸ƒå±€ç³»ç»Ÿ Grid Layout */
        .app-layout {
            display: grid;
            grid-template-columns: 1fr 280px; /* å·¦ä¾§è‡ªé€‚åº”ï¼Œå³ä¾§èµ„è®¯æ å›ºå®š 280px */
            grid-template-rows: 60px 1fr 300px 30px; /* é¡¶æ , åˆ—è¡¨, Kçº¿å›¾, æŒ‡æ•°æ  */
            gap: 12px;
            padding: 12px;
            height: 100vh;
        }

        /* é€šç”¨å¡ç‰‡æ ·å¼ */
        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            position: relative;
        }

        /* é¡¶éƒ¨æ  */
        .header {
            grid-column: 1 / -1; /* è·¨è¶Šä¸¤åˆ— */
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
            z-index: 10;
        }
        
        .header-content {
            display: flex;
            align-items: center;
            gap: 30px;
        }

        .stat-item { text-align: center; }
        .stat-label { font-size: 12px; color: var(--text-sub); margin-bottom: 2px; }
        .stat-value { font-size: 18px; font-weight: bold; font-family: monospace; }
        .divider { width: 1px; height: 24px; background-color: var(--border-color); }
        
        .tag {
            font-size: 12px; padding: 2px 6px; border-radius: 4px;
            background: rgba(59, 130, 246, 0.1); color: var(--accent-blue); border: 1px solid rgba(59, 130, 246, 0.3);
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn-group { display: flex; gap: 8px; margin-left: 20px; }
        .btn {
            padding: 6px; border-radius: 4px; border: none; cursor: pointer; color: white;
            transition: opacity 0.2s; display: flex; align-items: center; justify-content: center;
        }
        .btn-primary { background-color: var(--accent-blue); box-shadow: 0 0 10px rgba(59, 130, 246, 0.3); }
        .btn-secondary { background-color: #374151; color: #9ca3af; }
        .btn:hover { opacity: 0.8; }

        /* å·¦ä¾§åˆ—è¡¨åŒºåŸŸ */
        .main-list {
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* å†…éƒ¨æ»šåŠ¨ */
        }

        /* æœç´¢æ¡† */
        .search-bar { margin-bottom: 10px; position: relative; z-index: 20; }
        .search-input {
            width: 100%; background: #1f2937; border: 1px solid var(--border-color);
            color: white; padding: 8px 12px; border-radius: 4px; outline: none; font-size: 12px;
        }
        .search-input:focus { border-color: var(--accent-blue); }
        
        .search-dropdown {
            position: absolute; top: 100%; left: 0; width: 100%;
            background: #1f2937; border: 1px solid var(--border-color);
            max-height: 200px; overflow-y: auto; border-radius: 4px; margin-top: 4px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
        }
        .search-item {
            padding: 8px 12px; cursor: pointer; display: flex; justify-content: space-between; font-size: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .search-item:hover { background: #374151; }

        /* åŸºé‡‘ Grid */
        .fund-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 10px;
            overflow-y: auto;
            padding-bottom: 10px;
        }
        /* éšè—æ»šåŠ¨æ¡ä½†ä¿ç•™åŠŸèƒ½ */
        .fund-grid::-webkit-scrollbar { width: 4px; }
        .fund-grid::-webkit-scrollbar-thumb { background: #374151; border-radius: 2px; }

        .fund-card {
            padding: 12px; cursor: pointer; transition: all 0.2s; border: 1px solid var(--border-color);
        }
        .fund-card:hover { border-color: #4b5563; }
        .fund-card.active { 
            border-color: var(--accent-blue); 
            background-color: rgba(59, 130, 246, 0.05);
        }

        /* åŸºé‡‘å¡ç‰‡å†…å®¹ */
        .f-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .f-name { font-size: 13px; font-weight: bold; color: #e5e7eb; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100px; }
        .f-code { font-size: 10px; color: var(--text-sub); background: rgba(255,255,255,0.05); padding: 1px 4px; border-radius: 3px; }
        .f-rate { font-size: 14px; font-weight: bold; font-family: monospace; text-align: right; }
        .f-sub { font-size: 10px; color: var(--text-sub); text-align: right; }
        
        .f-footer { 
            display: flex; justify-content: space-between; align-items: flex-end; 
            border-top: 1px solid rgba(255,255,255,0.05); padding-top: 8px; margin-top: 4px;
        }
        .f-input { 
            background: transparent; border: none; border-bottom: 1px solid var(--border-color); 
            color: var(--text-main); width: 60px; font-family: monospace; font-size: 12px; outline: none;
        }
        .f-input:focus { border-color: var(--text-main); }

        .add-card {
            border: 1px dashed var(--border-color); color: var(--text-sub);
            display: flex; align-items: center; justify-content: center; height: 90px;
            cursor: pointer; font-size: 13px;
        }
        .add-card:hover { border-color: var(--accent-blue); color: var(--accent-blue); }

        .close-btn { position: absolute; top: 2px; right: 2px; color: #4b5563; background: none; border: none; cursor: pointer; font-size: 14px; opacity: 0; }
        .fund-card:hover .close-btn { opacity: 1; }
        .close-btn:hover { color: var(--up-color); }

        /* å³ä¾§èµ„è®¯æ  */
        .sidebar {
            grid-row: span 2; /* å ä¸¤è¡Œ */
            display: flex; flex-direction: column; overflow: hidden;
        }
        .sidebar-header {
            padding: 10px 15px; background: rgba(0,0,0,0.2); border-bottom: 1px solid var(--border-color);
            font-size: 12px; font-weight: bold; color: var(--accent-blue); display: flex; justify-content: space-between; align-items: center;
        }
        .news-list { flex: 1; overflow-y: auto; padding: 10px; }
        .news-item { display: flex; gap: 10px; margin-bottom: 15px; cursor: pointer; }
        .news-dot { width: 1px; background: var(--border-color); position: relative; margin-left: 4px; }
        .news-dot::before { content: ''; width: 5px; height: 5px; background: #4b5563; border-radius: 50%; position: absolute; top: 0; left: -2px; }
        .news-time { font-size: 10px; color: var(--text-sub); font-family: monospace; }
        .news-title { font-size: 12px; color: #d1d5db; line-height: 1.4; }
        .news-item:hover .news-title { color: white; }
        .news-item:hover .news-dot::before { background: var(--accent-blue); }

        /* åº•éƒ¨å›¾è¡¨ */
        .chart-container {
            display: flex; flex-direction: column; padding: 4px;
        }
        .chart-header {
            display: flex; justify-content: space-between; align-items: center; padding: 0 10px; height: 24px;
        }
        #mainChart { flex: 1; width: 100%; min-height: 0; border-radius: 4px; }

        /* åº•éƒ¨æŒ‡æ•°è·‘é©¬ç¯ */
        .footer {
            grid-column: 1 / -1;
            border-top: 1px solid var(--border-color);
            display: flex; align-items: center; padding: 0 20px; font-family: monospace; font-size: 12px;
            white-space: nowrap; overflow: hidden;
        }
        .marquee { display: flex; gap: 30px; animation: scroll 30s linear infinite; }
        @keyframes scroll { from { transform: translateX(0); } to { transform: translateX(-50%); } }

        /* é¢œè‰²å·¥å…·ç±» */
        .text-up { color: var(--up-color); }
        .text-down { color: var(--down-color); }
        .text-mono { font-family: monospace; }

        /* å¼¹çª— */
        .modal-mask {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 100;
            display: flex; justify-content: center; align-items: center;
        }
        .modal { background: var(--card-bg); width: 320px; padding: 20px; border-radius: 8px; border: 1px solid var(--border-color); }
        .modal-row { display: flex; justify-content: space-between; margin-bottom: 15px; align-items: center; font-size: 13px; }
    </style>
</head>
<body>

<div id="loading" style="position:fixed; inset:0; background:#000; color:#666; display:flex; justify-content:center; align-items:center; z-index:9999;">
    æ­£åœ¨ä»å›½å†…èŠ‚ç‚¹åŠ è½½èµ„æº...
</div>

<div id="app" style="display: none;"> <div class="app-layout">
        <header class="card header">
            <div class="header-content">
                <div class="stat-item">
                    <div class="stat-label">é¢„ä¼°ä»Šæ—¥æ”¶ç›Š</div>
                    <div class="stat-value" :class="totalDailyProfit >= 0 ? 'text-up' : 'text-down'">
                        {{ totalDailyProfit >= 0 ? '+' : '' }}{{ totalDailyProfit }}
                    </div>
                </div>
                
                <div class="divider"></div>
                
                <div class="stat-item" style="min-width: 100px;">
                    <div class="stat-label">
                        æŒæœ‰æ€»é¢
                        <span @click="togglePrivacy" style="cursor: pointer; margin-left:4px;">
                            {{ settings.privacyMode ? 'ğŸ”’' : 'ğŸ‘ï¸' }}
                        </span>
                    </div>
                    <div class="stat-value" style="color: white;">
                        {{ settings.privacyMode ? '****' : totalAmount }}
                    </div>
                </div>

                <div class="divider"></div>

                <div class="stat-item">
                    <div class="stat-label">æ•°æ®æº</div>
                    <div class="tag">{{ currentSourceName }}</div>
                </div>

                <div class="btn-group">
                    <button @click="manualRefresh" class="btn btn-primary" title="åˆ·æ–°æ•°æ®">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M4 4v5h.051M20 20v-5h-.051M9.8 15.6a6 6 0 10-3.6-7"></path>
                        </svg>
                    </button>
                    <button @click="showSettings = true" class="btn btn-secondary" title="è®¾ç½®">
                        âš™ï¸
                    </button>
                </div>
            </div>
        </header>

        <main class="main-list">
            <div class="search-bar">
                <input v-model="searchInput" @input="handleSearch" type="text" class="search-input" placeholder="ğŸ” è¾“å…¥ä»£ç æˆ–åç§°æ·»åŠ åŸºé‡‘...">
                <div v-if="searchResults.length" class="search-dropdown">
                    <div v-for="res in searchResults" @click="addFund(res)" class="search-item">
                        <span style="color:white">{{ res.NAME }}</span>
                        <span class="text-mono" style="color:#6b7280">{{ res.CODE }}</span>
                    </div>
                </div>
            </div>

            <div class="fund-grid">
                <div v-for="(fund, index) in funds" :key="fund.code" 
                     @click="selectFund(fund)"
                     class="card fund-card"
                     :class="{ 'active': selectedFundCode === fund.code }">
                    
                    <button @click.stop="removeFund(index)" class="close-btn">âœ•</button>

                    <div class="f-header">
                        <div>
                            <div class="f-name" :title="fund.name">{{ fund.name }}</div>
                            <span class="f-code">{{ fund.code }}</span>
                            <span v-if="fund.isNav" style="font-size:9px; background:#064e3b; color:#34d399; padding:0 2px; border-radius:2px;">å®</span>
                        </div>
                        <div>
                            <div class="f-rate" :class="fund.gszzl >= 0 ? 'text-up' : 'text-down'">{{ fund.gszzl }}%</div>
                            <div class="f-sub">æ¶¨å¹…</div>
                        </div>
                    </div>

                    <div class="f-footer">
                        <div>
                            <div class="f-sub" style="text-align:left">æŒä»“</div>
                            <div v-if="!settings.privacyMode">
                                <input type="number" v-model.number="fund.holdAmount" @click.stop @change="saveData" class="f-input" placeholder="0">
                            </div>
                            <div v-else class="text-mono" style="font-size:12px; color:#4b5563">****</div>
                        </div>
                        <div>
                            <div class="f-sub">æ”¶ç›Š</div>
                            <div class="text-mono" style="font-size:12px; font-weight:bold" :class="calcProfit(fund) >= 0 ? 'text-up' : 'text-down'">
                                {{ settings.privacyMode ? '***' : calcProfit(fund) }}
                            </div>
                        </div>
                    </div>
                </div>

                <div @click="$el.parentElement.previousElementSibling.querySelector('input').focus()" class="card add-card">
                    + æ·»åŠ åŸºé‡‘
                </div>
            </div>
        </main>

        <aside class="card sidebar">
            <div class="sidebar-header">
                <span>7x24 å¿«è®¯</span>
                <span style="width:6px; height:6px; background:var(--down-color); border-radius:50%; animation: pulse 2s infinite"></span>
            </div>
            <div class="news-list">
                <div v-for="(news, i) in newsList" :key="i" class="news-item">
                    <div class="news-dot"></div>
                    <div>
                        <div class="news-time">{{ news.time }}</div>
                        <div class="news-title">{{ news.title }}</div>
                    </div>
                </div>
            </div>
        </aside>

        <footer class="card chart-container">
            <div class="chart-header">
                <div style="display:flex; align-items:center; gap:8px;">
                    <span style="font-size:13px; font-weight:bold; color:#e5e7eb">{{ getSelectedFundName() || 'è¯·é€‰æ‹©åŸºé‡‘' }}</span>
                    <span v-if="selectedFundCode" class="text-mono" style="font-size:12px; color:#9ca3af">
                        ä¼°å€¼: <span style="color:white">{{ getSelectedFundVal() }}</span>
                    </span>
                </div>
                <div style="font-size:10px; color:#6b7280">{{ lastUpdateTime }}</div>
            </div>
            <div id="mainChart"></div>
        </footer>

        <div class="footer">
            <div style="color:#6b7280; margin-right:20px; font-weight:bold;">Global Indices:</div>
            <div class="marquee">
                <div v-for="n in 2" style="display:flex; gap:30px;">
                    <div v-for="idx in indices" :key="idx.name + n" style="display:flex; gap:6px;">
                        <span style="color:#9ca3af">{{ idx.name }}</span>
                        <span :class="idx.rate >= 0 ? 'text-up' : 'text-down'">{{ idx.rate }}%</span>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="showSettings" class="modal-mask" @click.self="showSettings = false">
            <div class="modal">
                <h3 style="color:white; margin-bottom:20px;">çœ‹æ¿è®¾ç½®</h3>
                
                <div class="modal-row">
                    <span style="color:#d1d5db">æ•°æ®æº</span>
                    <select v-model="settings.dataSource" @change="manualRefresh" style="background:#1f2937; color:white; border:1px solid #374151; padding:4px; border-radius:4px;">
                        <option value="eastmoney">å¤©å¤©åŸºé‡‘ (æ¨è)</option>
                        <option value="sina">æ–°æµªè´¢ç» (å¤‡é€‰)</option>
                    </select>
                </div>
                
                <div class="modal-row">
                    <span style="color:#d1d5db">éšç§æ¨¡å¼ (éšè—é‡‘é¢)</span>
                    <input type="checkbox" v-model="settings.privacyMode" style="accent-color: var(--accent-blue);">
                </div>

                <div style="text-align:right; margin-top:20px;">
                    <button @click="showSettings = false" class="btn btn-primary" style="width:100%">ä¿å­˜å¹¶å…³é—­</button>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    const { createApp, ref, computed, onMounted, nextTick } = Vue;

    createApp({
        setup() {
            // --- çŠ¶æ€å®šä¹‰ ---
            const funds = ref([]);
            const selectedFundCode = ref(null);
            const searchInput = ref("");
            const searchResults = ref([]);
            const lastUpdateTime = ref("--:--");
            const showSettings = ref(false);
            const chartHistory = ref({}); 
            
            const settings = ref({
                privacyMode: false,
                dataSource: 'eastmoney',
            });

            // æ¨¡æ‹Ÿæ•°æ® (å¯ä»¥åç»­å¯¹æ¥çœŸå®æ¥å£)
            const indices = ref([
                { name: 'ä¸Šè¯æŒ‡æ•°', rate: 0.23 },
                { name: 'çº³æ–¯è¾¾å…‹', rate: 1.45 },
                { name: 'æ’ç”Ÿç§‘æŠ€', rate: -0.56 },
                { name: 'æ ‡æ™®500', rate: 0.88 },
            ]);

            const newsList = ref([
                {time: '15:30', title: 'æ”¶ç›˜ï¼šæ²ªæŒ‡ç¼©é‡éœ‡è¡æ¶¨0.2%ï¼ŒAIæ¦‚å¿µè‚¡å…¨çº¿åå¼¹'},
                {time: '15:15', title: 'åŒ—å‘èµ„é‡‘å…¨å¤©å‡€ä¹°å…¥è¶…30äº¿å…ƒ'},
                {time: '14:40', title: 'åŠå¯¼ä½“æ¿å—åˆåæ‹‰å‡ï¼Œä¸­èŠ¯å›½é™…æ¶¨è¶…4%'},
                {time: '13:20', title: 'æ¸¯è‚¡æ’ç”Ÿç§‘æŠ€æŒ‡æ•°è·Œå¹…æ”¶çª„è‡³0.5%'},
                {time: '11:30', title: 'æ–°èƒ½æºèµ›é“å›æš–ï¼Œå®å¾·æ—¶ä»£æ¶¨è¶…2%'},
            ]);

            let chartInstance = null;

            // --- æ ¸å¿ƒæ–¹æ³• ---
            
            // 1. å¤©å¤©åŸºé‡‘æ¥å£
            const fetchEastMoney = (code) => {
                const ts = new Date().getTime();
                const script = document.createElement('script');
                script.src = `https://fundgz.1234567.com.cn/js/${code}.js?rt=${ts}`;
                document.body.appendChild(script);
                script.onload = () => document.body.removeChild(script);
            };

            // 2. æ–°æµªè´¢ç»æ¥å£ (å¤‡ç”¨)
            const fetchSina = (code) => {
                const script = document.createElement('script');
                script.src = `https://hq.sinajs.cn/list=f_${code}`;
                script.onload = () => {
                    const varName = `hq_str_f_${code}`;
                    if (window[varName]) {
                        const arr = window[varName].split(',');
                        const data = {
                            fundcode: code,
                            name: arr[0],
                            dwjz: arr[3], 
                            gsz: arr[1],  
                            gszzl: ((parseFloat(arr[1]) - parseFloat(arr[3])) / parseFloat(arr[3]) * 100).toFixed(2),
                            gztime: arr[4] 
                        };
                        processFundData(data);
                    }
                    document.body.removeChild(script);
                };
                document.body.appendChild(script);
            };

            // JSONP å›è°ƒ
            window.jsonpgz = (data) => { processFundData(data); };

            const processFundData = (data) => {
                const target = funds.value.find(f => f.code === data.fundcode);
                if (target) {
                    target.name = data.name;
                    target.dwjz = data.dwjz;
                    target.gsz = data.gsz;
                    target.gszzl = data.gszzl;
                    
                    // ç®€å•çš„åˆ¤æ–­æ˜¯å¦ä¸ºç¡®è®¤å‡€å€¼
                    const isToday = new Date().toLocaleDateString().indexOf(data.gztime.split(' ')[0]) > -1;
                    // target.isNav = !isToday; // ç®€å•é€»è¾‘ï¼Œä»…ä¾›å‚è€ƒ

                    recordChartData(target.code, data.gsz);
                    if (selectedFundCode.value === target.code) renderChart();
                }
            };

            const manualRefresh = () => {
                funds.value.forEach(f => {
                    if (settings.value.dataSource === 'eastmoney') fetchEastMoney(f.code);
                    else fetchSina(f.code);
                });
                lastUpdateTime.value = new Date().toLocaleTimeString();
                // æ¨¡æ‹Ÿåˆ·æ–°æŒ‡æ•°
                indices.value.forEach(i => i.rate = (Math.random() - 0.5).toFixed(2));
            };

            const handleSearch = () => {
                if(searchInput.value.length < 2) { searchResults.value = []; return; }
                const ts = new Date().getTime();
                const script = document.createElement('script');
                window.FundSearchCallBack = (data) => {
                    searchResults.value = data.Datas || [];
                    document.body.removeChild(script);
                };
                script.src = `https://fundsuggest.eastmoney.com/FundSearch/api/FundSearchAPI.ashx?m=1&key=${encodeURIComponent(searchInput.value)}&callback=FundSearchCallBack&_=${ts}`;
                document.body.appendChild(script);
            };

            const addFund = (res) => {
                if (!funds.value.find(f => f.code === res.CODE)) {
                    funds.value.push({ code: res.CODE, name: res.NAME, holdAmount: 0, gszzl: "0.00", gsz: "0.00" });
                    saveData();
                    manualRefresh();
                }
                searchInput.value = ""; searchResults.value = [];
            };

            const recordChartData = (code, value) => {
                if (!chartHistory.value[code]) chartHistory.value[code] = [];
                const arr = chartHistory.value[code];
                const now = new Date();
                const timeStr = `${now.getHours()}:${now.getMinutes()}:${now.getSeconds()}`;
                if (arr.length > 0 && arr[arr.length - 1].time === timeStr) return;
                arr.push({ time: timeStr, value: value });
                if (arr.length > 300) arr.shift();
            };

            const renderChart = () => {
                if (!selectedFundCode.value) return;
                const dom = document.getElementById('mainChart');
                if (!dom) return;
                if (!chartInstance) chartInstance = echarts.init(dom, 'dark');

                const data = chartHistory.value[selectedFundCode.value] || [];
                const color = (data.length > 1 && parseFloat(data[data.length-1].value) >= parseFloat(data[0].value)) ? '#FE2C39' : '#00B578';

                chartInstance.setOption({
                    backgroundColor: 'transparent',
                    grid: { top: 10, left: 0, right: 0, bottom: 20 },
                    tooltip: { trigger: 'axis' },
                    xAxis: { type: 'category', data: data.map(i=>i.time), show: false },
                    yAxis: { type: 'value', scale: true, show: false },
                    series: [{
                        type: 'line', data: data.map(i=>i.value), smooth: true, showSymbol: false,
                        lineStyle: { color: color, width: 2 },
                        areaStyle: {
                            color: new echarts.graphic.LinearGradient(0,0,0,1, [{offset:0,color:color},{offset:1,color:'transparent'}]), 
                            opacity: 0.2 
                        }
                    }]
                });
            };

            const selectFund = (fund) => {
                selectedFundCode.value = fund.code;
                nextTick(() => { 
                    if(chartInstance) chartInstance.resize(); 
                    renderChart(); 
                });
            };

            const calcProfit = (fund) => {
                if(!fund.holdAmount) return "0.00";
                return (fund.holdAmount * (parseFloat(fund.gszzl)/100)).toFixed(2);
            };

            const totalDailyProfit = computed(() => funds.value.reduce((acc, f) => acc + parseFloat(calcProfit(f)), 0).toFixed(2));
            const totalAmount = computed(() => funds.value.reduce((acc, f) => acc + (f.holdAmount || 0), 0).toFixed(2));
            const currentSourceName = computed(() => settings.value.dataSource === 'eastmoney' ? 'å¤©å¤©åŸºé‡‘' : 'æ–°æµªè´¢ç»');
            const getSelectedFundName = () => funds.value.find(i => i.code === selectedFundCode.value)?.name || '';
            const getSelectedFundVal = () => funds.value.find(i => i.code === selectedFundCode.value)?.gsz || '';

            const saveData = () => {
                localStorage.setItem('myFundsPro_v4', JSON.stringify(funds.value));
                localStorage.setItem('mySettings_v4', JSON.stringify(settings.value));
            };
            
            const loadData = () => {
                const d = localStorage.getItem('myFundsPro_v4');
                if(d) funds.value = JSON.parse(d);
                else funds.value = [{code:'009052', name:'ç¤ºä¾‹-è¯ºå®‰æˆé•¿æ··åˆ', holdAmount: 0, gszzl: '0.00'}];
                
                const s = localStorage.getItem('mySettings_v4');
                if(s) settings.value = JSON.parse(s);

                // é€ ä¸€äº›å‡æ•°æ®è®©å›¾è¡¨ä¸ä¸ºç©º
                funds.value.forEach(f => {
                    if(!chartHistory.value[f.code]) {
                        chartHistory.value[f.code] = [];
                        let base = 1.2;
                        for(let i=0; i<50; i++) {
                            base = base * (1 + (Math.random()-0.5)*0.01);
                            chartHistory.value[f.code].push({ time: `09:${i+10}`, value: base.toFixed(4) });
                        }
                    }
                });
                if(funds.value.length) selectFund(funds.value[0]);
            };

            const removeFund = (index) => {
                if(confirm("ç¡®å®šåˆ é™¤å—ï¼Ÿ")) {
                    funds.value.splice(index, 1);
                    if(funds.value.length === 0) selectedFundCode.value = null;
                    saveData();
                }
            };
            
            const togglePrivacy = () => { settings.value.privacyMode = !settings.value.privacyMode; saveData(); };

            onMounted(() => {
                // ç§»é™¤ loading
                document.getElementById('loading').style.display = 'none';
                document.getElementById('app').style.display = 'block';

                loadData();
                manualRefresh();
                setInterval(manualRefresh, 5000);
                window.addEventListener('resize', () => chartInstance && chartInstance.resize());
            });

            return {
                funds, searchInput, searchResults, selectedFundCode, lastUpdateTime, settings, showSettings, indices, newsList, currentSourceName,
                handleSearch, addFund, removeFund, selectFund, manualRefresh, togglePrivacy, saveData, calcProfit, 
                totalDailyProfit, totalAmount, getSelectedFundName, getSelectedFundVal
            };
        }
    }).mount('#app');
</script>
</body>
</html>
