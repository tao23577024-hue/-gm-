<!DOCTYPE html>
<html lang="zh-CN" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÊàëÁöÑÂü∫ÈáëÂÆûÁõò - ÈáëÈ¢ùÊ®°ÂºèÁâà</title>
    
    <script src="https://cdn.staticfile.net/vue/3.3.4/vue.global.prod.min.js"></script>
    <script src="https://cdn.staticfile.net/echarts/5.4.3/echarts.min.js"></script>
    
    <style>
        :root {
            --bg-color: #050505;
            --panel-bg: #101014;
            --border-color: #2a2a2a;
            --header-bg: #15151a;
            --text-main: #e0e0e0;
            --text-sub: #888;
            --accent: #2979ff;
            --up: #ff333a;       
            --down: #00e676;     
            --hover-bg: #1f1f25;
            --active-bg: #0d1b2e;
            --font-size-base: 12px;
        }

        html.light {
            --bg-color: #f0f2f5; --panel-bg: #ffffff; --border-color: #d9d9d9;
            --header-bg: #e6f7ff; --text-main: #333333; --text-sub: #666666;
            --up: #f5222d; --down: #52c41a; --hover-bg: #f5f5f5; --active-bg: #e6f7ff;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            background-color: var(--bg-color); 
            color: var(--text-main); 
            font-family: "Consolas", "Microsoft YaHei", monospace; 
            height: 100vh; width: 100vw; overflow: hidden; 
            font-size: var(--font-size-base);
        }

        #debug-console {
            position: fixed; bottom: 0; right: 0; width: 300px; max-height: 150px;
            background: rgba(100, 0, 0, 0.9); color: white; font-size: 10px;
            overflow-y: auto; z-index: 9999; padding: 5px; display: none; pointer-events: none;
        }

        .layout {
            display: grid;
            grid-template-columns: 260px 1fr 200px;
            grid-template-rows: 60px minmax(0, 1fr); 
            gap: 4px; padding: 4px;
            height: 100vh;
        }

        .panel {
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            display: flex; flex-direction: column;
            overflow: hidden; border-radius: 4px;
        }
        .panel-header {
            height: 28px; flex-shrink: 0;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 8px;
            background: var(--header-bg);
            border-bottom: 1px solid var(--border-color);
            font-weight: bold; color: var(--accent);
            font-size: var(--font-size-base);
        }

        .top-bar {
            grid-column: 1 / 4;
            display: flex; align-items: center; justify-content: space-around;
            background: var(--panel-bg); border: 1px solid var(--border-color);
            border-radius: 4px;
        }
        .stat-box { text-align: center; }
        .stat-label { color: var(--text-sub); font-size: 11px; margin-bottom: 2px;}
        .stat-val { font-size: 18px; font-weight: bold; font-family: sans-serif; }

        .col-left { grid-row: 2 / 3; grid-column: 1 / 2; }
        .fund-list { flex: 1; overflow-y: auto; }
        .fund-item { padding: 10px 8px; border-bottom: 1px solid var(--border-color); cursor: pointer; }
        .fund-item:hover { background: var(--hover-bg); }
        .fund-item.active { background: var(--active-bg); border-left: 2px solid var(--accent); }
        .fi-row { display: flex; justify-content: space-between; align-items: baseline; line-height: 1.4; }
        .fi-name { font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 140px; font-size: 13px; }

        .col-center { 
            grid-row: 2 / 3; grid-column: 2 / 3; 
            display: grid; grid-template-rows: 2fr 1fr; gap: 4px; 
            min-height: 0; 
        }
        .chart-area { width: 100%; height: 100%; position: relative; }
        .data-area { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; overflow: hidden; min-height: 0; }
        
        .data-table { width: 100%; border-collapse: collapse; font-size: 11px; }
        .data-table th, .data-table td { text-align: right; padding: 4px 6px; border-bottom: 1px solid var(--border-color); white-space: nowrap; }
        .data-table th { position: sticky; top: 0; background: var(--panel-bg); color: var(--text-sub); z-index: 1; }
        .data-table td.name-col { text-align: left; max-width: 100px; overflow: hidden; text-overflow: ellipsis; }

        .col-right { grid-row: 2 / 3; grid-column: 3 / 4; padding: 0; gap: 4px; border:none; background: transparent; box-shadow: none; display: flex; flex-direction: column; overflow: hidden;}
        
        .control-panel {
            background: var(--panel-bg); border: 1px solid var(--border-color); border-radius: 4px;
            padding: 8px; display: flex; flex-direction: column; gap: 8px;
        }
        
        .compact-row { display: flex; flex-direction: column; gap: 2px; }
        .compact-label { font-size: 10px; color: var(--text-sub); }
        
        .input-group { display: flex; gap: 4px; align-items: center;}
        .input-mini { 
            flex: 1; background: var(--bg-color); border: 1px solid var(--border-color); 
            color: var(--text-main); padding: 4px; border-radius: 2px; font-size: 12px; outline: none; width: 0; 
        }
        .input-mini:focus { border-color: var(--accent); }
        
        .btn-mini {
            padding: 0 8px; height: 24px; font-size: 11px; border: none; border-radius: 2px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; white-space: nowrap;
        }
        .btn-blue { background: var(--accent); color: white; }
        .btn-red { background: #d32f2f; color: white; opacity: 0.8; }
        .btn-red:hover { opacity: 1; }

        .search-res { flex:1; overflow-y: auto; border: 1px solid var(--border-color); background: var(--bg-color); font-size: 11px; margin-top:2px; min-height: 0; }
        .search-row { padding: 6px; border-bottom: 1px solid var(--border-color); cursor: pointer; }
        .search-row:hover { background: var(--hover-bg); }

        .tools-row { display: flex; justify-content: space-between; margin-top: auto; padding-top: 5px; border-top: 1px dashed var(--border-color); }
        .tool-icon { cursor: pointer; opacity: 0.6; font-size: 14px; }
        .tool-icon:hover { opacity: 1; color: var(--accent); }

        .t-up { color: var(--up) !important; } .t-down { color: var(--down) !important; }
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }
        ::-webkit-scrollbar-track { background: transparent; }
        [v-cloak] { display: none; }
    </style>
</head>
<body>

<div id="debug-console"></div>

<div id="app" v-cloak class="layout">
    
    <header class="top-bar">
        <div class="stat-box">
            <div class="stat-label">‰ªäÊó•Êî∂Áõä</div>
            <div class="stat-val" :class="totalDailyProfit >= 0 ? 't-up' : 't-down'">{{ totalDailyProfit }}</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">ÊÄªËµÑ‰∫ß</div>
            <div class="stat-val" style="color:var(--text-main)">{{ settings.privacyMode ? '****' : totalAssetValue }}</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">Êó•Ê∂®ÂπÖ</div>
            <div class="stat-val" :class="dailyTotalRate >= 0 ? 't-up' : 't-down'">{{ dailyTotalRate }}%</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">Âà∑Êñ∞</div>
            <div class="stat-val" style="font-size:14px; color:var(--text-sub)">{{ refreshCountdown }}s</div>
        </div>
    </header>

    <aside class="panel col-left">
        <div class="panel-header">
            <span>Âü∫ÈáëÊ±† ({{ funds.length }})</span>
            <span style="cursor:pointer" @click="manualRefresh" title="Âº∫Âà∂Âà∑Êñ∞">‚Üª</span>
        </div>
        <div class="fund-list">
            <div v-for="fund in funds" :key="fund.code" @click="selectFund(fund)" class="fund-item" :class="{ 'active': selectedFundCode === fund.code }">
                <div class="fi-row">
                    <span class="fi-name">{{ fund.name }}</span>
                    <span :class="parseFloat(fund.gszzl)>=0?'t-up':'t-down'" style="font-weight:bold">{{ fund.gszzl }}%</span>
                </div>
                <div class="fi-row" style="margin-top:4px;">
                    <span style="font-size:10px; color:var(--text-sub)">{{ fund.code }}</span>
                    <span style="font-size:11px; font-weight:bold; color:var(--text-main)">
                        {{ settings.privacyMode ? '****' : getFundAmount(fund) }}
                    </span>
                </div>
                <div class="fi-row" style="margin-top:2px;" v-if="!settings.privacyMode && fund.shares > 0">
                    <span style="font-size:10px; color:var(--text-sub)">‰ªäÊó•:</span>
                    <span :class="calcProfitRaw(fund) >= 0 ? 't-up' : 't-down'" style="font-weight:bold; font-size:12px;">
                        {{ calcProfitRaw(fund) >= 0 ? '+' : '' }}{{ calcProfitRaw(fund) }}
                    </span>
                </div>
            </div>
        </div>
    </aside>

    <main class="col-center">
        <div class="panel chart-area">
            <div class="panel-header" style="position:absolute; width:100%; background:transparent; border:none; z-index:10; padding-top:6px;">
                <span>{{ getSelectedFundName() }}</span>
                <span :class="getSelectedFundRate() >= 0 ? 't-up' : 't-down'">
                    {{ getSelectedFundVal() }} ({{ getSelectedFundRate() }}%)
                </span>
                <span style="font-size:10px; margin-left:10px; color:#666; font-weight:normal">
                    {{ isMarketOpen ? '‚óè ‰∫§Êòì‰∏≠' : '‚óè ‰ºëÂ∏Ç' }}
                </span>
            </div>
            <div id="mainChart" style="width:100%; height:100%;"></div>
        </div>
        
        <div class="data-area">
            <div class="panel">
                <div class="panel-header" style="height:24px; font-size:11px;">Ëøë10Êó•ÂáÄÂÄº</div>
                <div style="flex:1; overflow-y:auto;">
                    <table class="data-table">
                        <thead><tr><th>Êó•Êúü</th><th>ÂáÄÂÄº</th><th>Ê∂®ÂπÖ</th></tr></thead>
                        <tbody>
                            <tr v-for="h in historyData">
                                <td>{{ h.date.slice(5) }}</td>
                                <td>{{ h.nav }}</td>
                                <td :class="parseFloat(h.rate)>=0?'t-up':'t-down'">{{ h.rate }}%</td>
                            </tr>
                            <tr v-if="!historyData.length"><td colspan="3" style="text-align:center; color:#666; padding:10px;">{{ statusMsg }}</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="panel">
                <div class="panel-header" style="height:24px; font-size:11px;">Èáç‰ªìËÇ°Á•®</div>
                <div style="flex:1; overflow-y:auto;">
                    <table class="data-table">
                        <thead><tr><th style="text-align:left">ËÇ°Á•®ÂêçÁß∞</th><th>‰ª£Á†Å</th></tr></thead>
                        <tbody>
                            <tr v-for="s in holdingsData">
                                <td class="name-col" style="font-weight:bold; color:var(--text-main)">{{ s.name }}</td>
                                <td style="color:var(--text-sub)">{{ s.code }}</td>
                            </tr>
                            <tr v-if="!holdingsData.length"><td colspan="2" style="text-align:center; color:#666; padding:10px;">{{ stockStatusMsg }}</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <aside class="col-right">
        <div class="control-panel" v-if="selectedFundCode" style="flex-shrink:0">
            <div class="compact-row">
                <span class="compact-label">ÂΩìÂâçÈÄâ‰∏≠</span>
                <div style="font-weight:bold; font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:var(--accent)">
                    {{ getSelectedFundName() }}
                </div>
            </div>
            
            <div class="compact-row">
                <span class="compact-label">ÊåÅÊúâÈáëÈ¢ù (CNY)</span>
                <div class="input-group">
                    <input type="number" v-model.number="currentFundEdit.amount" class="input-mini" placeholder="¬•">
                    <button class="btn-mini btn-blue" @click="saveCurrentFund" title="‰øùÂ≠ò">OK</button>
                </div>
                <div style="font-size:10px; color:var(--text-sub); text-align:right">
                    (Ëá™Âä®ÊäòÁÆó‰ªΩÈ¢ù)
                </div>
            </div>

            <div style="text-align:right; margin-top:2px;">
                <button class="btn-mini btn-red" style="width:100%" @click="removeCurrentFund">Âà†Èô§Ê≠§Âü∫Èáë</button>
            </div>
        </div>
        <div v-else class="control-panel" style="text-align:center; color:var(--text-sub); font-size:11px; flex-shrink:0; padding:20px 0;">
            ËØ∑Âú®Â∑¶‰æß<br>ÈÄâÊã©Âü∫Èáë
        </div>

        <div class="control-panel" style="flex:1; display:flex; flex-direction:column; min-height:0;">
            <div class="compact-row" style="flex-shrink:0;">
                <span class="compact-label">Ê∑ªÂä†Âü∫Èáë (Êêú‰ª£Á†Å/Âêç)</span>
                <input v-model="searchInput" @input="handleSearch" class="input-mini" style="width:100%" placeholder="Â¶Ç 000001">
            </div>
            
            <div class="search-res" v-if="searchResults.length">
                <div v-for="res in searchResults" @click="addFund(res)" class="search-row">
                    <div style="font-weight:bold">{{ res.NAME }}</div>
                    <div style="color:var(--text-sub); font-size:10px;">{{ res.CODE }}</div>
                </div>
            </div>
            <div v-else style="flex:1;"></div>

            <div class="tools-row" style="flex-shrink:0;">
                <div class="tool-icon" @click="settings.privacyMode = !settings.privacyMode" title="ÈöêÁßÅÊ®°Âºè">
                    {{ settings.privacyMode ? 'üëÅÔ∏è' : 'üëì' }}
                </div>
                <div class="tool-icon" @click="toggleTheme" title="ÂàáÊç¢‰∏ªÈ¢ò">
                    {{ isLightMode ? 'üåû' : 'üåö' }}
                </div>
                <input type="range" min="10" max="14" v-model="settings.fontSize" @input="updateFont" style="width:50px;" title="Â≠óÂè∑">
            </div>
        </div>
    </aside>
</div>

<script>
    // ÂÖ®Â±ÄÈîôËØØÊçïËé∑
    window.onerror = function(msg, url, line) {
        const consoleDiv = document.getElementById('debug-console');
        consoleDiv.style.display = 'block';
        consoleDiv.innerHTML += `<div>‚ùå ${msg}</div>`;
        return false;
    };

    const { createApp, ref, computed, onMounted, nextTick } = Vue;

    createApp({
        setup() {
            const funds = ref([]);
            const selectedFundCode = ref(null);
            const searchInput = ref("");
            const searchResults = ref([]);
            const historyData = ref([]); 
            const holdingsData = ref([]); 
            const isLightMode = ref(false);
            const refreshCountdown = ref(5);
            const settings = ref({ privacyMode: false, fontSize: 12 });
            const currentFundEdit = ref({ amount: 0 }); // ‰øÆÊîπÔºö‰ΩøÁî® amount
            const isMarketOpen = ref(false);
            const statusMsg = ref("Êó†Êï∞ÊçÆ");
            const stockStatusMsg = ref("Êó†Êï∞ÊçÆ");

            let chartInstance = null;
            let timerInterval = null;

            const checkMarketStatus = () => {
                const now = new Date();
                const day = now.getDay();
                const hour = now.getHours();
                const minute = now.getMinutes();
                const timeVal = hour * 60 + minute;
                if (day === 0 || day === 6) return false;
                if (timeVal >= 570 && timeVal <= 900) return true;
                return false;
            };

            const fetchFundData = (code) => {
                const ts = new Date().getTime();
                const script = document.createElement('script');
                script.src = `https://fundgz.1234567.com.cn/js/${code}.js?rt=${ts}`;
                script.onload = () => script.remove();
                script.onerror = () => {
                    script.remove();
                    console.log(`Fund ${code} load failed`);
                };
                document.body.appendChild(script);
            };

            window.jsonpgz = (data) => {
                const target = funds.value.find(f => f.code === data.fundcode);
                if (target) {
                    target.name = data.name; 
                    target.gsz = data.gsz; 
                    target.gszzl = data.gszzl; 
                    target.lastTime = data.gztime;
                    if (selectedFundCode.value === target.code) renderChart();
                }
            };

            const fetchDetailData = (code) => {
                historyData.value = []; 
                holdingsData.value = [];
                statusMsg.value = "Âä†ËΩΩ‰∏≠...";
                stockStatusMsg.value = "Êü•ËØ¢‰∏≠...";
                
                const ts = new Date().getTime();
                const script = document.createElement('script');
                script.src = `https://fund.eastmoney.com/pingzhongdata/${code}.js?v=${ts}`;
                
                script.onload = () => {
                    if (window.Data_netWorthTrend) {
                        historyData.value = window.Data_netWorthTrend.slice(-10).reverse().map(i => ({
                            date: new Date(i.x).toISOString().split('T')[0], 
                            nav: i.y, 
                            rate: i.equityReturn
                        }));
                    } else {
                        statusMsg.value = "ÊöÇÊó†ÂáÄÂÄºÊï∞ÊçÆ";
                    }

                    if (window.stockCodes && window.stockCodes.length > 0) {
                        const codes = window.stockCodes.slice(0, 10);
                        fetchStockNamesGtimg(codes);
                    } else {
                        stockStatusMsg.value = "Êó†ÊåÅ‰ªìÊï∞ÊçÆ";
                    }
                    script.remove();
                };
                script.onerror = () => {
                    statusMsg.value = "Êï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•";
                    stockStatusMsg.value = "Âä†ËΩΩÂ§±Ë¥•";
                    script.remove();
                }
                document.body.appendChild(script);
            };

            const fetchStockNamesGtimg = (codes) => {
                const qqCodes = codes.map(c => {
                    if (c.startsWith('6')) return `sh${c}`;
                    if (c.startsWith('0') || c.startsWith('3')) return `sz${c}`;
                    if (c.startsWith('4') || c.startsWith('8')) return `bj${c}`;
                    return `sh${c}`;
                }).join(',');

                const script = document.createElement('script');
                script.src = `https://qt.gtimg.cn/q=${qqCodes}`;
                script.charset = "utf-8"; 
                
                script.onload = () => {
                    const result = [];
                    codes.forEach((c, index) => {
                        const qqCode = qqCodes.split(',')[index];
                        const varName = `v_${qqCode}`;
                        let name = c; 
                        if (window[varName]) {
                            const parts = window[varName].split('~');
                            if (parts.length > 1) name = parts[1];
                        }
                        result.push({ code: c, name: name });
                    });
                    holdingsData.value = result;
                    script.remove();
                };
                script.onerror = () => {
                    stockStatusMsg.value = "ÂêçÁß∞Êé•Âè£Ë¢´Êã¶Êà™";
                    holdingsData.value = codes.map(c => ({code:c, name:"Êú™Áü•"}));
                    script.remove();
                }
                document.body.appendChild(script);
            };

            const deterministicNoise = (seed) => {
                const x = Math.sin(seed * 9999) * 10000;
                return (x - Math.floor(x)) - 0.5;
            };

            const renderChart = () => {
                if (!selectedFundCode.value) return;
                const dom = document.getElementById('mainChart');
                if (!dom) return;
                if (!chartInstance) chartInstance = echarts.init(dom);
                
                const target = funds.value.find(f => f.code === selectedFundCode.value);
                if(!target) return;

                isMarketOpen.value = checkMarketStatus();
                
                const currentVal = parseFloat(target.gsz);
                const rate = parseFloat(target.gszzl);
                const preClose = currentVal / (1 + rate / 100); 
                const codeSeed = parseInt(target.code) || 12345;

                const dataPoints = [];
                const totalMinutes = 240; 
                let endMinute = totalMinutes;

                if (isMarketOpen.value) {
                    const now = new Date();
                    const h = now.getHours();
                    const m = now.getMinutes();
                    let minutesPassed = 0;
                    if (h < 12) minutesPassed = (h - 9) * 60 + (m - 30);
                    else minutesPassed = 120 + (h - 13) * 60 + m; 
                    if (minutesPassed < 0) minutesPassed = 0;
                    if (minutesPassed > 240) minutesPassed = 240;
                    endMinute = minutesPassed;
                }

                const step = (currentVal - preClose) / endMinute; 
                
                for (let i = 0; i <= endMinute; i++) {
                    let hour, minute;
                    if (i <= 120) { 
                        const totalM = 570 + i; 
                        hour = Math.floor(totalM / 60);
                        minute = totalM % 60;
                    } else { 
                        const totalM = 780 + (i - 120); 
                        hour = Math.floor(totalM / 60);
                        minute = totalM % 60;
                    }
                    const timeStr = `${hour.toString().padStart(2,'0')}:${minute.toString().padStart(2,'0')}`;
                    
                    let val;
                    if (i === endMinute) {
                        val = currentVal;
                    } else {
                        const base = preClose + step * i;
                        const amplitude = Math.abs(currentVal - preClose) * 0.1 || 0.002;
                        const noise = deterministicNoise(codeSeed + i) * amplitude;
                        val = base + noise;
                    }
                    dataPoints.push({ time: timeStr, value: val.toFixed(4) });
                }

                const color = rate >= 0 ? '#ff333a' : '#00e676';

                chartInstance.setOption({
                    animation: false,
                    grid: { top: 30, left: 0, right: 0, bottom: 0 },
                    tooltip: { 
                        trigger: 'axis', 
                        formatter: p => `${p[0].name}<br />‰º∞ÂÄº: ${p[0].value}`,
                        backgroundColor: 'rgba(20,20,20,0.9)',
                        borderColor: '#333',
                        textStyle: { color: '#eee' }
                    },
                    xAxis: { type: 'category', data: dataPoints.map(i=>i.time), show: false },
                    yAxis: { 
                        type: 'value', scale: true, show: false,
                        min: Math.min(preClose, currentVal) * 0.995, 
                        max: Math.max(preClose, currentVal) * 1.005
                    },
                    series: [{
                        type: 'line', data: dataPoints.map(i=>i.value), showSymbol: false,
                        lineStyle: { width: 1.5, color: color },
                        areaStyle: { 
                            color: new echarts.graphic.LinearGradient(0,0,0,1, [
                                {offset:0, color:color},
                                {offset:1, color:'transparent'}
                            ]), 
                            opacity: 0.15 
                        }
                    },
                    {
                        type: 'line',
                        markLine: {
                            data: [{ yAxis: preClose }],
                            symbol: 'none',
                            lineStyle: { type: 'dashed', color: '#666', width: 0.5 },
                            label: { show: false }
                        }
                    }]
                });
            };

            const handleSearch = () => {
                if(searchInput.value.length < 2) { searchResults.value = []; return; }
                const s = document.createElement('script');
                window.FundSearchCallBack = (d) => { searchResults.value = d.Datas || []; s.remove(); };
                s.src = `https://fundsuggest.eastmoney.com/FundSearch/api/FundSearchAPI.ashx?m=1&key=${encodeURIComponent(searchInput.value)}&callback=FundSearchCallBack`;
                document.body.appendChild(s);
            };

            const addFund = (res) => {
                if (!funds.value.find(f => f.code === res.CODE)) {
                    funds.value.push({ code: res.CODE, name: res.NAME, shares: 0, gszzl: "0.00", gsz: "0.00" });
                    saveData(); fetchFundData(res.CODE);
                }
                searchInput.value = ""; searchResults.value = [];
            };

            // ÈÄâ‰∏≠Âü∫ÈáëÊó∂ÔºåÂ∞Ü shares ËΩ¨Êç¢‰∏∫ amount Â°´ÂÖ•ÁºñËæëÊ°Ü
            const selectFund = (f) => {
                selectedFundCode.value = f.code;
                const gsz = parseFloat(f.gsz) || 1;
                // ÂèçÁÆóÔºöAmount = Shares * NAV
                currentFundEdit.value.amount = (f.shares * gsz).toFixed(2);
                fetchDetailData(f.code);
                setTimeout(() => {
                   if(chartInstance) chartInstance.resize(); 
                   renderChart();
                }, 100);
            };

            // ‰øùÂ≠òÈÄªËæëÔºöÁî®Êà∑ËæìÂÖ•ÁöÑÊòØÈáëÈ¢ùÔºåÊàë‰ª¨Ë¶ÅÂ≠òÁöÑÊòØ‰ªΩÈ¢ù
            const saveCurrentFund = () => {
                const t = funds.value.find(f => f.code === selectedFundCode.value);
                if(t) { 
                    const gsz = parseFloat(t.gsz) || 1;
                    // Ê≠£ÁÆóÔºöShares = Amount / NAV
                    const amt = parseFloat(currentFundEdit.value.amount) || 0;
                    t.shares = amt / gsz;
                    saveData(); 
                }
            };
            
            const removeCurrentFund = () => {
                if(confirm('Âà†Èô§?')) {
                    funds.value = funds.value.filter(f => f.code !== selectedFundCode.value);
                    selectedFundCode.value = null; saveData(); chartInstance?.clear();
                }
            };

            // ËæÖÂä©ËÆ°ÁÆóÔºöÊòæÁ§∫ÈáëÈ¢ù (Display Amount)
            const getFundAmount = (f) => {
                const amt = (f.shares * parseFloat(f.gsz || 0)).toFixed(2);
                return `¬•${amt}`;
            };

            // ËæÖÂä©ËÆ°ÁÆóÔºö‰ªäÊó•Áõà‰∫è
            const calcProfitRaw = (f) => {
                if(!f.shares) return "0.00";
                const v = ((parseFloat(f.gsz) - parseFloat(f.gsz)/(1+parseFloat(f.gszzl)/100)) * f.shares).toFixed(2);
                return isNaN(v) ? "0.00" : v;
            };

            const totalDailyProfit = computed(() => funds.value.reduce((a, b) => a + parseFloat(calcProfitRaw(b)), 0).toFixed(2));
            const totalAssetValue = computed(() => funds.value.reduce((a, b) => a + (parseFloat(b.gsz)||0)*b.shares, 0).toFixed(0));
            const dailyTotalRate = computed(() => {
                const p = parseFloat(totalDailyProfit.value), a = parseFloat(totalAssetValue.value);
                const base = a - p;
                return (base <= 0.1) ? "0.00" : ((p/base)*100).toFixed(2);
            });
            
            const getSelectedFundName = () => funds.value.find(i=>i.code===selectedFundCode.value)?.name || '';
            const getSelectedFundVal = () => funds.value.find(i=>i.code===selectedFundCode.value)?.gsz || '--';
            const getSelectedFundRate = () => funds.value.find(i=>i.code===selectedFundCode.value)?.gszzl || 0;

            const toggleTheme = () => { isLightMode.value = !isLightMode.value; document.documentElement.className = isLightMode.value ? 'light' : 'dark'; };
            const updateFont = () => document.documentElement.style.setProperty('--font-size-base', settings.value.fontSize + 'px');
            const saveData = () => localStorage.setItem('myFunds_V3_AmountMode', JSON.stringify(funds.value));
            
            const manualRefresh = () => {
                funds.value.forEach(f => fetchFundData(f.code));
                if (selectedFundCode.value) renderChart();
            };

            onMounted(() => {
                try {
                    const d = localStorage.getItem('myFunds_V3_AmountMode');
                    if(d) funds.value = JSON.parse(d);
                    else funds.value = [{code:'000001', name:'Á§∫‰æãÂü∫Èáë', shares:0, gszzl:'0.00', gsz:'1.000'}];
                    
                    manualRefresh();
                    
                    setInterval(() => { 
                        refreshCountdown.value--; 
                        if(refreshCountdown.value<=0) { 
                            manualRefresh(); 
                            refreshCountdown.value=10; 
                        } 
                    }, 1000);

                    window.addEventListener('resize', () => chartInstance && chartInstance.resize());
                } catch(e) {
                    console.error("Init error:", e);
                }
            });

            return {
                funds, selectedFundCode, searchInput, searchResults, historyData, holdingsData, settings, currentFundEdit, isLightMode, refreshCountdown, isMarketOpen, statusMsg, stockStatusMsg,
                selectFund, handleSearch, addFund, manualRefresh, saveCurrentFund, removeCurrentFund, toggleTheme, updateFont,
                totalDailyProfit, totalAssetValue, dailyTotalRate, getSelectedFundName, getSelectedFundVal, getSelectedFundRate, calcProfitRaw, getFundAmount
            };
        }
    }).mount('#app');
</script>
</body>
</html>
