<!DOCTYPE html>
<html lang="zh-CN" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„åŸºé‡‘å®ç›˜ - Pro UIç‰ˆ</title>
    
    <script src="https://cdn.staticfile.net/vue/3.3.4/vue.global.prod.min.js"></script>
    <script src="https://cdn.staticfile.net/echarts/5.4.3/echarts.min.js"></script>
    
    <style>
        :root {
            /* å‚è€ƒå›¾ç‰‡é…è‰² */
            --bg-body: #0b0f19;      /* ææ·±è“èƒŒæ™¯ */
            --bg-panel: #151a28;     /* é¢æ¿èƒŒæ™¯ */
            --bg-card: #1c2233;      /* å¡ç‰‡é«˜äº®èƒŒæ™¯ */
            --bg-input: #0f131f;     /* è¾“å…¥æ¡†èƒŒæ™¯ */
            
            --text-main: #eef2f5;    /* ä¸»æ–‡å­— */
            --text-sub: #78859e;     /* æ¬¡è¦æ–‡å­— */
            --text-dim: #4a5568;     /* æš—æ·¡æ–‡å­— */
            
            --accent: #3b82f6;       /* ç§‘æŠ€è“ */
            --accent-glow: rgba(59, 130, 246, 0.3);
            
            --up: #fa5252;           /* æ¶¨ - çº¢ */
            --down: #00e676;         /* è·Œ - ç»¿ */
            
            --border-radius: 8px;
            --border-soft: rgba(255,255,255,0.05);
            
            --font-size-base: 12px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body { 
            background-color: var(--bg-body); 
            color: var(--text-main); 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            height: 100vh; width: 100vw; overflow: hidden; 
            font-size: var(--font-size-base);
        }

        /* æ»šåŠ¨æ¡ç¾åŒ– */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #2d3748; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #4a5568; }

        /* å¸ƒå±€ç½‘æ ¼ */
        .layout {
            display: grid;
            grid-template-columns: 260px 1fr 240px; 
            grid-template-rows: 70px minmax(0, 1fr); 
            gap: 12px; padding: 12px;
            height: 100vh;
        }

        /* é€šç”¨é¢æ¿æ ·å¼ */
        .panel {
            background: var(--bg-panel);
            border: 1px solid var(--border-soft);
            border-radius: var(--border-radius);
            display: flex; flex-direction: column;
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .panel-header {
            height: 36px; flex-shrink: 0;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 12px;
            border-bottom: 1px solid var(--border-soft);
            font-weight: 600; color: var(--text-sub);
            font-size: 13px;
        }

        /* --- é¡¶éƒ¨æ€»è§ˆæ¡ --- */
        .top-bar {
            grid-column: 1 / 4;
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;
            background: transparent; border: none; box-shadow: none;
        }
        
        .stat-card {
            background: var(--bg-panel);
            border: 1px solid var(--border-soft);
            border-radius: var(--border-radius);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            height: 100%;
        }
        .stat-label { color: var(--text-sub); font-size: 12px; margin-bottom: 4px; }
        .stat-val { font-size: 20px; font-weight: 700; font-family: "DIN Alternate", sans-serif; letter-spacing: 0.5px; }

        /* --- å·¦ä¾§åˆ—è¡¨ --- */
        .col-left { grid-row: 2 / 3; grid-column: 1 / 2; }
        
        .fund-list { flex: 1; overflow-y: auto; padding: 8px; }
        .fund-item { 
            padding: 12px; margin-bottom: 8px; 
            background: var(--bg-card); border-radius: 6px;
            border: 1px solid transparent; cursor: pointer;
            transition: all 0.2s;
        }
        .fund-item:hover { transform: translateY(-1px); border-color: var(--text-sub); }
        .fund-item.active { 
            background: rgba(59, 130, 246, 0.15); 
            border-color: var(--accent); 
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.1);
        }
        
        .fi-row { display: flex; justify-content: space-between; align-items: baseline; line-height: 1.5; }
        .fi-name { font-weight: 600; color: var(--text-main); font-size: 13px; max-width: 140px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis;}
        .fi-code { font-size: 11px; color: var(--text-sub); font-family: monospace; }
        .fi-amount { font-size: 12px; color: var(--text-main); font-weight: bold; }

        /* --- ä¸­é—´åŒºåŸŸ --- */
        .col-center { 
            grid-row: 2 / 3; grid-column: 2 / 3; 
            display: grid; grid-template-rows: auto 2fr 3fr; gap: 12px; 
            min-height: 0; background: transparent; border: none; box-shadow: none; overflow: hidden;
        }

        /* è¯¦æƒ…æ¦‚è§ˆå¡ç‰‡ (æ¨¡ä»¿å›¾ç‰‡) */
        .detail-card {
            background: var(--bg-panel); border-radius: var(--border-radius); padding: 15px;
            display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;
            border: 1px solid var(--border-soft);
        }
        .dc-item { display: flex; flex-direction: column; }
        .dc-label { font-size: 12px; color: var(--text-sub); margin-bottom: 6px; }
        .dc-val { font-size: 24px; font-weight: bold; font-family: sans-serif; }
        .dc-sub { font-size: 12px; margin-left: 5px; opacity: 0.8; font-weight: normal; }

        /* å›¾è¡¨åŒº */
        .chart-panel { background: var(--bg-panel); border-radius: var(--border-radius); border: 1px solid var(--border-soft); position: relative; }
        
        /* åº•éƒ¨ï¼šé‡ä»“è‚¡ (æ¨¡ä»¿å›¾ç‰‡åˆ—è¡¨) */
        .holdings-panel { 
            background: var(--bg-panel); border-radius: var(--border-radius); border: 1px solid var(--border-soft); 
            display: flex; flex-direction: column; overflow: hidden;
        }
        .holdings-list { flex: 1; overflow-y: auto; padding: 0 10px; }
        
        .stock-row { 
            display: flex; align-items: center; justify-content: space-between; 
            padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.03); 
        }
        .sr-left { display: flex; flex-direction: column; width: 30%; }
        .sr-name { font-size: 13px; font-weight: 600; color: var(--text-main); }
        .sr-code { font-size: 11px; color: var(--text-sub); }
        
        .sr-mid { flex: 1; padding: 0 15px; display: flex; align-items: center; }
        .progress-bg { flex: 1; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; }
        .progress-bar { height: 100%; background: var(--accent); border-radius: 3px; }
        
        .sr-right { width: 15%; text-align: right; font-size: 12px; color: var(--text-main); font-weight: bold; }

        /* --- å³ä¾§æ“ä½œåŒº --- */
        .col-right { grid-row: 2 / 3; grid-column: 3 / 4; display: flex; flex-direction: column; gap: 12px; }

        .control-group {
            background: var(--bg-panel); border-radius: var(--border-radius); padding: 15px;
            border: 1px solid var(--border-soft); display: flex; flex-direction: column; gap: 12px;
        }

        /* æœç´¢æ¡† (æ¨¡ä»¿å›¾ç‰‡) */
        .search-box {
            background: var(--bg-input); border: 1px solid var(--border-soft);
            border-radius: 20px; padding: 8px 15px; display: flex; align-items: center;
        }
        .search-input { 
            background: transparent; border: none; color: var(--text-main); 
            width: 100%; outline: none; font-size: 13px; 
        }
        
        /* æŒ‰é’® */
        .btn {
            border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;
            font-weight: 600; font-size: 12px; transition: all 0.2s; text-align: center;
        }
        .btn-primary { 
            background: var(--accent); color: white; 
            box-shadow: 0 0 10px var(--accent-glow);
        }
        .btn-primary:hover { background: #2563eb; }
        .btn-danger { background: rgba(250, 82, 82, 0.1); color: #fa5252; border: 1px solid rgba(250, 82, 82, 0.2); }
        .btn-danger:hover { background: rgba(250, 82, 82, 0.2); }

        .input-styled {
            background: var(--bg-input); border: 1px solid var(--border-soft);
            color: var(--text-main); padding: 8px; border-radius: 6px;
            width: 100%; outline: none; font-family: monospace;
        }
        .input-styled:focus { border-color: var(--accent); }

        .label { font-size: 11px; color: var(--text-sub); margin-bottom: 4px; display: block; }

        .t-up { color: var(--up) !important; } .t-down { color: var(--down) !important; }
        [v-cloak] { display: none; }
        
        /* é”™è¯¯æ—¥å¿— */
        #debug-console { position: fixed; bottom: 0; right: 0; z-index: 9999; background: rgba(0,0,0,0.8); color: red; font-size: 10px; padding: 5px; display:none;}
    </style>
</head>
<body>

<div id="debug-console"></div>

<div id="app" v-cloak class="layout">
    
    <header class="top-bar">
        <div class="stat-card">
            <span class="stat-label">ä»Šæ—¥é¢„ä¼°æ”¶ç›Š</span>
            <span class="stat-val" :class="totalDailyProfit >= 0 ? 't-up' : 't-down'">{{ totalDailyProfit }}</span>
        </div>
        <div class="stat-card">
            <span class="stat-label">æ€»èµ„äº§ (CNY)</span>
            <span class="stat-val" style="color: var(--text-main)">{{ settings.privacyMode ? '****' : totalAssetValue }}</span>
        </div>
        <div class="stat-card">
            <span class="stat-label">ä»Šæ—¥æ¶¨å¹…</span>
            <span class="stat-val" :class="dailyTotalRate >= 0 ? 't-up' : 't-down'">{{ dailyTotalRate }}%</span>
        </div>
        <div class="stat-card">
            <span class="stat-label">è‡ªåŠ¨åˆ·æ–°</span>
            <span class="stat-val" style="color: var(--accent); font-size: 16px;">{{ refreshCountdown }}s</span>
        </div>
    </header>

    <aside class="panel col-left">
        <div class="panel-header">
            <span>è‡ªé€‰åŸºé‡‘ ({{ funds.length }})</span>
            <span style="cursor:pointer; font-size:16px;" @click="manualRefresh" title="åˆ·æ–°">â†»</span>
        </div>
        <div class="fund-list">
            <div v-for="fund in funds" :key="fund.code" @click="selectFund(fund)" class="fund-item" :class="{ 'active': selectedFundCode === fund.code }">
                <div class="fi-row">
                    <span class="fi-name">{{ fund.name }}</span>
                    <span :class="parseFloat(fund.gszzl)>=0?'t-up':'t-down'" style="font-weight:bold">{{ fund.gszzl }}%</span>
                </div>
                <div class="fi-row" style="margin-top:6px;">
                    <span class="fi-code">{{ fund.code }}</span>
                    <span class="fi-amount">
                        {{ settings.privacyMode ? '****' : getFundAmount(fund) }}
                    </span>
                </div>
                <div class="fi-row" style="margin-top:4px;" v-if="!settings.privacyMode && fund.shares > 0">
                    <span style="font-size:10px; color:var(--text-dim)">Today</span>
                    <span :class="calcProfitRaw(fund) >= 0 ? 't-up' : 't-down'" style="font-size:11px;">
                        {{ calcProfitRaw(fund) >= 0 ? '+' : '' }}{{ calcProfitRaw(fund) }}
                    </span>
                </div>
            </div>
        </div>
    </aside>

    <main class="col-center">
        <div class="detail-card">
            <div class="dc-item">
                <span class="dc-label">ä¼°ç®—å‡€å€¼ ({{ getSelectedFundDate() }})</span>
                <span class="dc-val" :class="getSelectedFundRate() >= 0 ? 't-up' : 't-down'">
                    {{ getSelectedFundVal() }}
                </span>
            </div>
            <div class="dc-item" style="border-left: 1px solid var(--border-soft); padding-left: 20px;">
                <span class="dc-label">ä¼°ç®—æ¶¨è·Œå¹…</span>
                <span class="dc-val" :class="getSelectedFundRate() >= 0 ? 't-up' : 't-down'">
                    {{ getSelectedFundRate() }}%
                </span>
            </div>
            <div class="dc-item" style="border-left: 1px solid var(--border-soft); padding-left: 20px;">
                <span class="dc-label">äº¤æ˜“çŠ¶æ€</span>
                <span class="dc-val" style="color: var(--accent); font-size: 16px; line-height: 28px;">
                    {{ isMarketOpen ? 'â— äº¤æ˜“ä¸­' : 'â— ä¼‘å¸‚' }}
                </span>
                <span class="dc-label" style="margin-top:0">{{ getSelectedFundName() }}</span>
            </div>
        </div>

        <div class="chart-panel">
            <div id="mainChart" style="width:100%; height:100%;"></div>
        </div>

        <div class="holdings-panel">
            <div class="panel-header">é‡ä»“è‚¡ç¥¨æŒä»“ (Top 10)</div>
            <div class="holdings-list">
                <div v-for="s in holdingsData" :key="s.code" class="stock-row">
                    <div class="sr-left">
                        <span class="sr-name">{{ s.name }}</span>
                        <span class="sr-code">{{ s.code }}</span>
                    </div>
                    <div class="sr-mid">
                        <div class="progress-bg">
                            <div class="progress-bar" :style="{ width: (Math.random() * 40 + 20) + '%' }"></div>
                        </div>
                    </div>
                    <div class="sr-right">
                        <span style="color:var(--text-dim)">--%</span>
                    </div>
                </div>
                <div v-if="!holdingsData.length" style="padding:20px; text-align:center; color:var(--text-sub)">
                    {{ stockStatusMsg }}
                </div>
            </div>
        </div>
    </main>

    <aside class="col-right">
        
        <div class="control-group" v-if="selectedFundCode">
            <div>
                <span class="label">å½“å‰æŒæœ‰é‡‘é¢ (CNY)</span>
                <div style="display:flex; gap:8px;">
                    <input type="number" v-model.number="currentFundEdit.amount" class="input-styled" placeholder="0.00">
                    <button class="btn btn-primary" @click="saveCurrentFund">ä¿å­˜</button>
                </div>
                <div style="text-align:right; font-size:10px; color:var(--text-dim); margin-top:4px;">
                    æŠ˜åˆä»½é¢: {{ ((parseFloat(currentFundEdit.amount)||0) / (parseFloat(getSelectedFundVal())||1)).toFixed(2) }}
                </div>
            </div>
            
            <button class="btn btn-danger" @click="removeCurrentFund" style="width:100%">åˆ é™¤æ­¤åŸºé‡‘</button>
        </div>
        <div v-else class="control-group" style="text-align:center; padding: 40px 0; color: var(--text-sub);">
            è¯·å…ˆåœ¨å·¦ä¾§<br>é€‰æ‹©ä¸€åªåŸºé‡‘
        </div>

        <div class="control-group" style="flex:1; min-height:0;">
            <span class="label">æ·»åŠ æ–°åŸºé‡‘</span>
            <div class="search-box">
                <span style="margin-right:8px; opacity:0.5">ğŸ”</span>
                <input v-model="searchInput" @input="handleSearch" class="search-input" placeholder="è¾“å…¥ä»£ç æˆ–åç§°">
            </div>

            <div style="flex:1; overflow-y:auto; margin-top:10px;">
                <div v-for="res in searchResults" @click="addFund(res)" 
                     style="padding:10px; border-bottom:1px solid var(--border-soft); cursor:pointer; font-size:12px;">
                    <div style="color:var(--text-main); font-weight:bold">{{ res.NAME }}</div>
                    <div style="color:var(--text-sub)">{{ res.CODE }}</div>
                </div>
            </div>
        </div>

        <div class="control-group" style="flex-direction: row; justify-content: space-between; align-items: center;">
            <span class="label" style="margin:0">éšç§æ¨¡å¼</span>
            <div @click="settings.privacyMode = !settings.privacyMode" style="cursor:pointer; font-size:18px;">
                {{ settings.privacyMode ? 'ğŸ”’' : 'ğŸ‘ï¸' }}
            </div>
        </div>

    </aside>

</div>

<script>
    window.onerror = function(msg) {
        document.getElementById('debug-console').style.display='block';
        document.getElementById('debug-console').innerHTML+=`<div>${msg}</div>`;
    };

    const { createApp, ref, computed, onMounted } = Vue;

    createApp({
        setup() {
            const funds = ref([]);
            const selectedFundCode = ref(null);
            const searchInput = ref("");
            const searchResults = ref([]);
            const historyData = ref([]); 
            const holdingsData = ref([]); 
            const refreshCountdown = ref(5);
            const settings = ref({ privacyMode: false });
            const currentFundEdit = ref({ amount: 0 });
            const isMarketOpen = ref(false);
            const statusMsg = ref("æ— æ•°æ®");
            const stockStatusMsg = ref("ç‚¹å‡»åŸºé‡‘æŸ¥çœ‹è¯¦æƒ…");

            let chartInstance = null;

            // --- æ ¸å¿ƒé€»è¾‘ ---

            const checkMarketStatus = () => {
                const now = new Date();
                const day = now.getDay();
                const min = now.getHours() * 60 + now.getMinutes();
                if (day === 0 || day === 6) return false;
                return (min >= 570 && min <= 900);
            };

            const fetchFundData = (code) => {
                const ts = new Date().getTime();
                const s = document.createElement('script');
                s.src = `https://fundgz.1234567.com.cn/js/${code}.js?rt=${ts}`;
                s.onload = () => s.remove();
                s.onerror = () => s.remove();
                document.body.appendChild(s);
            };

            window.jsonpgz = (data) => {
                const target = funds.value.find(f => f.code === data.fundcode);
                if (target) {
                    target.name = data.name; 
                    target.gsz = data.gsz; 
                    target.gszzl = data.gszzl; 
                    target.lastTime = data.gztime;
                    if (selectedFundCode.value === target.code) renderChart();
                }
            };

            const fetchDetailData = (code) => {
                holdingsData.value = [];
                stockStatusMsg.value = "åŠ è½½ä¸­...";
                
                const ts = new Date().getTime();
                const s = document.createElement('script');
                s.src = `https://fund.eastmoney.com/pingzhongdata/${code}.js?v=${ts}`;
                
                s.onload = () => {
                    // è‚¡ç¥¨æŒä»“
                    if (window.stockCodes && window.stockCodes.length > 0) {
                        fetchStockNamesGtimg(window.stockCodes.slice(0, 10));
                    } else {
                        stockStatusMsg.value = "æ— æŒä»“æ•°æ®";
                    }
                    s.remove();
                };
                s.onerror = () => { stockStatusMsg.value = "åŠ è½½å¤±è´¥"; s.remove(); };
                document.body.appendChild(s);
            };

            const fetchStockNamesGtimg = (codes) => {
                const qqCodes = codes.map(c => {
                    if (c.startsWith('6')) return `sh${c}`;
                    if (c.startsWith('0') || c.startsWith('3')) return `sz${c}`;
                    if (c.startsWith('4') || c.startsWith('8')) return `bj${c}`;
                    return `sh${c}`;
                }).join(',');

                const s = document.createElement('script');
                s.src = `https://qt.gtimg.cn/q=${qqCodes}`;
                s.charset = "utf-8";
                
                s.onload = () => {
                    const res = [];
                    codes.forEach((c, idx) => {
                        const vName = `v_${qqCodes.split(',')[idx]}`;
                        let name = c;
                        if (window[vName]) {
                            const parts = window[vName].split('~');
                            if (parts.length > 1) name = parts[1];
                        }
                        res.push({ code: c, name: name });
                    });
                    holdingsData.value = res;
                    s.remove();
                };
                s.onerror = () => { stockStatusMsg.value = "æ¥å£æ‹¦æˆª"; s.remove(); };
                document.body.appendChild(s);
            };

            // --- ç¡®å®šæ€§ Kçº¿ (é˜²ä¹±è·³) ---
            const deterministicNoise = (seed) => {
                const x = Math.sin(seed * 9999) * 10000;
                return (x - Math.floor(x)) - 0.5;
            };

            const renderChart = () => {
                if (!selectedFundCode.value) return;
                const dom = document.getElementById('mainChart');
                if (!dom) return;
                if (!chartInstance) chartInstance = echarts.init(dom);
                
                const target = funds.value.find(f => f.code === selectedFundCode.value);
                if(!target) return;

                isMarketOpen.value = checkMarketStatus();
                
                const currentVal = parseFloat(target.gsz);
                const rate = parseFloat(target.gszzl);
                const preClose = currentVal / (1 + rate / 100); 
                const codeSeed = parseInt(target.code) || 12345;

                const dataPoints = [];
                let endMinute = 240;

                if (isMarketOpen.value) {
                    const now = new Date();
                    const h = now.getHours();
                    const m = now.getMinutes();
                    let mp = (h < 12) ? (h - 9) * 60 + (m - 30) : 120 + (h - 13) * 60 + m;
                    if (mp < 0) mp = 0; if (mp > 240) mp = 240;
                    endMinute = mp;
                }

                const step = (currentVal - preClose) / endMinute; 
                
                for (let i = 0; i <= endMinute; i++) {
                    let h, m;
                    if (i <= 120) { h = Math.floor((570+i)/60); m = (570+i)%60; }
                    else { h = Math.floor((780+i-120)/60); m = (780+i-120)%60; }
                    const timeStr = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`;
                    
                    let val = (i === endMinute) ? currentVal : (preClose + step * i + deterministicNoise(codeSeed + i) * (Math.abs(currentVal - preClose) * 0.1 || 0.002));
                    dataPoints.push({ time: timeStr, value: val.toFixed(4) });
                }

                const color = rate >= 0 ? '#fa5252' : '#00e676'; // çº¢æ¶¨ç»¿è·Œ
                const bgGradient = new echarts.graphic.LinearGradient(0,0,0,1, [{offset:0, color:color},{offset:1, color:'rgba(0,0,0,0)'}]);

                chartInstance.setOption({
                    animation: false,
                    grid: { top: 10, left: 0, right: 0, bottom: 0 },
                    tooltip: { 
                        trigger: 'axis', 
                        formatter: p => `${p[0].name}<br />ä¼°å€¼: ${p[0].value}`,
                        backgroundColor: 'rgba(20,28,40,0.9)', borderColor: '#333', textStyle: { color: '#eee' }
                    },
                    xAxis: { type: 'category', data: dataPoints.map(i=>i.time), show: false },
                    yAxis: { type: 'value', scale: true, show: false, min: Math.min(preClose, currentVal)*0.995, max: Math.max(preClose, currentVal)*1.005 },
                    series: [{
                        type: 'line', data: dataPoints.map(i=>i.value), showSymbol: false,
                        lineStyle: { width: 2, color: color },
                        areaStyle: { color: bgGradient, opacity: 0.2 }
                    }, {
                        type: 'line', markLine: { data: [{ yAxis: preClose }], symbol: 'none', lineStyle: { type: 'dashed', color: '#666', width: 0.5 }, label: { show: false } }
                    }]
                });
            };

            const handleSearch = () => {
                if(searchInput.value.length < 2) { searchResults.value = []; return; }
                const s = document.createElement('script');
                window.FundSearchCallBack = (d) => { searchResults.value = d.Datas || []; s.remove(); };
                s.src = `https://fundsuggest.eastmoney.com/FundSearch/api/FundSearchAPI.ashx?m=1&key=${encodeURIComponent(searchInput.value)}&callback=FundSearchCallBack`;
                document.body.appendChild(s);
            };

            const addFund = (res) => {
                if (!funds.value.find(f => f.code === res.CODE)) {
                    funds.value.push({ code: res.CODE, name: res.NAME, shares: 0, gszzl: "0.00", gsz: "0.00" });
                    saveData(); fetchFundData(res.CODE);
                }
                searchInput.value = ""; searchResults.value = [];
            };

            const selectFund = (f) => {
                selectedFundCode.value = f.code;
                currentFundEdit.value.amount = (f.shares * (parseFloat(f.gsz)||1)).toFixed(2);
                fetchDetailData(f.code);
                setTimeout(() => { if(chartInstance) chartInstance.resize(); renderChart(); }, 100);
            };

            const saveCurrentFund = () => {
                const t = funds.value.find(f => f.code === selectedFundCode.value);
                if(t) { 
                    t.shares = (parseFloat(currentFundEdit.value.amount) || 0) / (parseFloat(t.gsz) || 1);
                    saveData(); 
                }
            };
            
            const removeCurrentFund = () => {
                if(confirm('ç¡®è®¤åˆ é™¤?')) {
                    funds.value = funds.value.filter(f => f.code !== selectedFundCode.value);
                    selectedFundCode.value = null; saveData(); chartInstance?.clear();
                }
            };

            // æ•°æ®è®¡ç®—
            const getFundAmount = (f) => `Â¥${(f.shares * parseFloat(f.gsz || 0)).toFixed(2)}`;
            const calcProfitRaw = (f) => (!f.shares ? "0.00" : ((parseFloat(f.gsz) - parseFloat(f.gsz)/(1+parseFloat(f.gszzl)/100)) * f.shares).toFixed(2));
            
            const totalDailyProfit = computed(() => funds.value.reduce((a, b) => a + parseFloat(calcProfitRaw(b)), 0).toFixed(2));
            const totalAssetValue = computed(() => funds.value.reduce((a, b) => a + (parseFloat(b.gsz)||0)*b.shares, 0).toFixed(0));
            const dailyTotalRate = computed(() => {
                const p = parseFloat(totalDailyProfit.value), a = parseFloat(totalAssetValue.value);
                const base = a - p;
                return (base <= 0.1) ? "0.00" : ((p/base)*100).toFixed(2);
            });
            
            const getSelectedFundName = () => funds.value.find(i=>i.code===selectedFundCode.value)?.name || '';
            const getSelectedFundVal = () => funds.value.find(i=>i.code===selectedFundCode.value)?.gsz || '--';
            const getSelectedFundRate = () => funds.value.find(i=>i.code===selectedFundCode.value)?.gszzl || 0;
            const getSelectedFundDate = () => {
                const t = funds.value.find(i=>i.code===selectedFundCode.value)?.lastTime;
                return t ? t.split(' ')[0] : '--';
            }

            const saveData = () => localStorage.setItem('myFunds_Pro_UI', JSON.stringify(funds.value));
            const manualRefresh = () => { funds.value.forEach(f => fetchFundData(f.code)); if(selectedFundCode.value) renderChart(); };

            onMounted(() => {
                const d = localStorage.getItem('myFunds_Pro_UI');
                if(d) funds.value = JSON.parse(d);
                else funds.value = [{code:'000001', name:'ç¤ºä¾‹åŸºé‡‘', shares:0, gszzl:'0.00', gsz:'1.000'}];
                
                manualRefresh();
                setInterval(() => { 
                    refreshCountdown.value--; 
                    if(refreshCountdown.value<=0) { manualRefresh(); refreshCountdown.value=10; } 
                }, 1000);
                window.addEventListener('resize', () => chartInstance && chartInstance.resize());
            });

            return {
                funds, selectedFundCode, searchInput, searchResults, holdingsData, settings, currentFundEdit, refreshCountdown, isMarketOpen, stockStatusMsg,
                selectFund, handleSearch, addFund, manualRefresh, saveCurrentFund, removeCurrentFund,
                totalDailyProfit, totalAssetValue, dailyTotalRate, 
                getSelectedFundName, getSelectedFundVal, getSelectedFundRate, getSelectedFundDate,
                calcProfitRaw, getFundAmount
            };
        }
    }).mount('#app');
</script>
</body>
</html>
